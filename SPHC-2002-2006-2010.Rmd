---
title: "Fluidity of self-reported sexual identity in Stockholm County from 2010 to 2021"
author: Guoqiang Zhang (guoqiang.zhang@ki.se)
output: html_notebook
editor_options: 
  chunk_output_type: console
---

Notes:

This R Notebook presents the analyses among participants in SPHC-B 2002, 2006, and 2010 who provided data on sexual identity in at least two of the three follow-up surveys (SPHC-F 2010, 2014, and 2021). The analyses include:
- Visual presentation of changes in sexual identity in 2010-2021.
- Relationship between changes in sexual identity and key demographic factors.

The analyses of relationship between changes in sexual identity and key demographic factors in SPHC 2010 and 2014 are available, respectively, in the R Notebooks "SPHC-2010" and "SPHC-2014".

### 1. Load Packages
```{r}
library(haven)
library(naniar)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(ggalluvial)
library(ggbreak)
library(ggrepel)
library(grDevices)
library(finalfit)
library(sandwich)
library(lmtest)
source("/Users/guoqiang.zhang/Documents/Karolinska Institutet/Research Projects/Trends and Fluidity of Sexual Identity/Sexual_identity_in_Stockholm_County/Helper_functions.R") # helper function
```

### 2. The Stockholm Public Health Cohort
#### 2.1. SPHC-B 2002 with SPHC-F 2010-2021
```{r}
d_2002 <- read_sas("/Volumes/LGBT Project data/sphc02_07_10_14_21.sas7bdat")

# sexual identity in 2010
table( d_2002$F10F103, useNA = "always" )
d_2002$F10F103[ d_2002$F10F103 == 9 ] <- NA
d_2002$sexual_identity_2010 <- factor( ifelse( d_2002$F10F103 == 1, "Heterosexual",
                                                  ifelse( d_2002$F10F103 == 2, "Homosexual",
                                                          ifelse( d_2002$F10F103 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2002$sexual_identity_2010, useNA = "always" )

# sexual identity in 2014
table( d_2002$F14F103, useNA = "always" )
d_2002$sexual_identity_2014 <- factor( ifelse( d_2002$F14F103 == 1, "Heterosexual",
                                                  ifelse( d_2002$F14F103 == 2, "Homosexual",
                                                          ifelse( d_2002$F14F103 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2002$sexual_identity_2014, useNA = "always" )

# sexual identity in 2021
table( d_2002$F21F91, useNA = "always" )
d_2002$sexual_identity_2021 <- factor( ifelse( d_2002$F21F91 == 1, "Heterosexual",
                                                  ifelse( d_2002$F21F91 == 2, "Homosexual",
                                                          ifelse( d_2002$F21F91 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2002$sexual_identity_2021, useNA = "always" )

# sex
table( d_2002$kon, useNA = "always" )
d_2002$sex <- factor( ifelse( d_2002$kon == 1, "Male", "Female" ),
                      levels = c( "Male", "Female" ) )
table( d_2002$sex, useNA = "always" )

# age
summary( d_2002$F2alder )
d_2002$age_2002 <- d_2002$F2alder
d_2002$age_2010 <- d_2002$age_2002 + 8
d_2002$age_2010_cat <- factor( ifelse( d_2002$age_2010 <= 29, "16-29", 
                                       ifelse( d_2002$age_2010 >=30 & d_2002$age_2010 <= 44, "30-44",
                                               ifelse( d_2002$age_2010 >= 45 & d_2002$age_2010 <= 59, "45-59", ">=60" ) ) ),
                               levels = c( "16-29", "30-44", "45-59", ">=60" ) )
table( d_2002$age_2010_cat, useNA = "always" )

# country of birth
table( d_2002$fodelseland, useNA = "always" )
d_2002$fodelseland[ d_2002$fodelseland == "" ] <- NA
d_2002$country_of_birth <- factor( ifelse( d_2002$fodelseland == "Afrika", "Africa",
                                           ifelse( d_2002$fodelseland == "Asien", "Asia",
                                                   ifelse( d_2002$fodelseland == "Europa", "Europe",
                                                           ifelse( d_2002$fodelseland == "Sverige", "Sweden", "Americas" ) ) ) ),
                                   levels = c( "Africa", "Americas", "Asia", "Europe", "Sweden" ) )
table( d_2002$country_of_birth, useNA = "always" )

# sampling strata
n_miss( d_2002$stratum )
d_2002$sampling_strata <- as.factor( d_2002$stratum )
length( unique( d_2002$sampling_strata ) )

strata_region_name <- readxl::read_xlsx("/Users/guoqiang.zhang/Documents/Karolinska Institutet/Research Projects/SPHC/Data for LGB projects/Stratum.xlsx")

strata_region_name$region_2002 <- as.factor( strata_region_name$region_2002 )

d_2002 <- d_2002 %>% 
  left_join( strata_region_name[ , c( 1, 5 ) ], by = c( "sampling_strata" = "region_2002" ) )

d_2002$sampling_strata_region <- d_2002$sdk_2002

d_2002$sampling_strata_region <- ifelse( d_2002$sampling_strata == "998" | d_2002$sampling_strata == "999", "Unknown",
                                         d_2002$sampling_strata_region )


##### design weights #####

summary( d_2002$F2dvikt )
d_2002$design_weight <- d_2002$F2dvikt


##### non-response #####

# unit non-response
d_2002$design_weight_unit_nonresponse <- d_2002$F2dbvikt # weights calculated assuming Missing Completely At Random (MCAR) within each stratum
summary( d_2002$design_weight_unit_nonresponse )
sum( d_2002$design_weight_unit_nonresponse ) # No. of source population = 1,402,160


##### summary of stratified sampling #####

# because stratified random sampling was done by region and sex,
# the following analyses were conducted separately for males and females

# among males
d_2002_males <- d_2002 %>% filter( sex == "Male" )

unitresponse_prob <- d_2002_males %>% 
  group_by( sampling_strata_region ) %>% 
  summarise( unitresponse_prob = unique( design_weight ) / unique( design_weight_unit_nonresponse ),
             no.of.population = sum( design_weight_unit_nonresponse ),
             sample_size = unique( no.of.population )/unique( design_weight ) ) # calculate overall unit response rate, and no. of population and sample size within each stratum

d_2002_males <- d_2002_males %>% 
  left_join( unitresponse_prob, by = "sampling_strata_region" )

itemresponse_prob <- d_2002_males %>% 
  group_by( sampling_strata_region ) %>% 
  summarise( itemresponse_prob = sum( !is.na( sexual_identity_2010 ) ) / n() ) # calculate item response rate

d_2002_males <- d_2002_males %>% 
  left_join( itemresponse_prob, by = "sampling_strata_region" ) %>% 
  mutate( itemresponse_prob = ifelse( is.na( sexual_identity_2010 ), 0, itemresponse_prob ) )

sampling_frame_2002_males <- as.data.frame( d_2002_males %>% 
                                        group_by( sampling_strata_region ) %>% 
                                        reframe( no.of.population = unique( no.of.population ), 
                                                 sample_size = unique( no.of.population/design_weight ),
                                                 unitresponse = n(),
                                                 itemresponse = sum( itemresponse_prob != 0 ) ) )

sampling_frame_2002_males$unitresponse_rate <- sampling_frame_2002_males$unitresponse/sampling_frame_2002_males$sample_size
sampling_frame_2002_males$itemresponse_rate <- sampling_frame_2002_males$itemresponse/sampling_frame_2002_males$unitresponse
sampling_frame_2002_males$overallresponse_rate <- sampling_frame_2002_males$itemresponse/sampling_frame_2002_males$sample_size

sampling_frame_2002_males$unitresponse_label <- paste0( sampling_frame_2002_males$unitresponse, " (", 
                                                  sprintf( "%.1f", sampling_frame_2002_males$unitresponse_rate*100 ), "%)" )
sampling_frame_2002_males$overallresponse_label <- paste0( sampling_frame_2002_males$itemresponse, " (", 
                                                     sprintf( "%.1f", sampling_frame_2002_males$overallresponse_rate*100 ), "%)" )

round( sum( sampling_frame_2002_males$unitresponse )/( sum( sampling_frame_2002_males$sample_size ) ), 3 ) # overall unit response rate
round( sum( sampling_frame_2002_males$itemresponse )/( sum( sampling_frame_2002_males$unitresponse ) ), 3 ) # overall item response rate
round( sum( sampling_frame_2002_males$itemresponse )/( sum( sampling_frame_2002_males$sample_size ) ), 3 ) # overall response rate

writexl::write_xlsx( sampling_frame_2002_males, "sampling_frame_2002_males.xlsx" )


# among females
d_2002_females <- d_2002 %>% filter( sex == "Female" )

unitresponse_prob <- d_2002_females %>% 
  group_by( sampling_strata_region ) %>% 
  summarise( unitresponse_prob = unique( design_weight ) / unique( design_weight_unit_nonresponse ),
             no.of.population = sum( design_weight_unit_nonresponse ),
             sample_size = unique( no.of.population )/unique( design_weight ) ) # calculate overall unit response rate, and no. of population and sample size within each stratum

d_2002_females <- d_2002_females %>% 
  left_join( unitresponse_prob, by = "sampling_strata_region" )

itemresponse_prob <- d_2002_females %>% 
  group_by( sampling_strata_region ) %>% 
  summarise( itemresponse_prob = sum( !is.na( sexual_identity_2010 ) ) / n() ) # calculate item response rate

d_2002_females <- d_2002_females %>% 
  left_join( itemresponse_prob, by = "sampling_strata_region" ) %>% 
  mutate( itemresponse_prob = ifelse( is.na( sexual_identity_2010 ), 0, itemresponse_prob ) )

sampling_frame_2002_females <- as.data.frame( d_2002_females %>% 
                                        group_by( sampling_strata_region ) %>% 
                                        reframe( no.of.population = unique( no.of.population ), 
                                                 sample_size = unique( no.of.population/design_weight ),
                                                 unitresponse = n(),
                                                 itemresponse = sum( itemresponse_prob != 0 ) ) )

sampling_frame_2002_females$unitresponse_rate <- sampling_frame_2002_females$unitresponse/sampling_frame_2002_females$sample_size
sampling_frame_2002_females$itemresponse_rate <- sampling_frame_2002_females$itemresponse/sampling_frame_2002_females$unitresponse
sampling_frame_2002_females$overallresponse_rate <- sampling_frame_2002_females$itemresponse/sampling_frame_2002_females$sample_size

sampling_frame_2002_females$unitresponse_label <- paste0( sampling_frame_2002_females$unitresponse, " (", 
                                                  sprintf( "%.1f", sampling_frame_2002_females$unitresponse_rate*100 ), "%)" )
sampling_frame_2002_females$overallresponse_label <- paste0( sampling_frame_2002_females$itemresponse, " (", 
                                                     sprintf( "%.1f", sampling_frame_2002_females$overallresponse_rate*100 ), "%)" )

round( sum( sampling_frame_2002_females$unitresponse )/( sum( sampling_frame_2002_females$sample_size ) ), 3 ) # overall unit response rate
round( sum( sampling_frame_2002_females$itemresponse )/( sum( sampling_frame_2002_females$unitresponse ) ), 3 ) # overall item response rate
round( sum( sampling_frame_2002_females$itemresponse )/( sum( sampling_frame_2002_females$sample_size ) ), 3 ) # overall response rate

writexl::write_xlsx( sampling_frame_2002_females, "sampling_frame_2002_females.xlsx" )
```

#### 2.2. SPHC-B 2006 with SPHC-F 2010-2021
```{r}
d_2006 <- read_sas("/Volumes/LGBT Project data/sphc06_10_14_21.sas7bdat")

# sexual identity in 2010
table( d_2006$F10F103, useNA = "always" )
d_2006$F10F103[ d_2006$F10F103 == 9 ] <- NA
d_2006$sexual_identity_2010 <- factor( ifelse( d_2006$F10F103 == 1, "Heterosexual",
                                                  ifelse( d_2006$F10F103 == 2, "Homosexual",
                                                          ifelse( d_2006$F10F103 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2006$sexual_identity_2010, useNA = "always" )

# sexual identity in 2014
table( d_2006$F14F103, useNA = "always" )
d_2006$sexual_identity_2014 <- factor( ifelse( d_2006$F14F103 == 1, "Heterosexual",
                                                  ifelse( d_2006$F14F103 == 2, "Homosexual",
                                                          ifelse( d_2006$F14F103 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2006$sexual_identity_2014, useNA = "always" )

# sexual identity in 2021
table( d_2006$F21F91, useNA = "always" )
d_2006$sexual_identity_2021 <- factor( ifelse( d_2006$F21F91 == 1, "Heterosexual",
                                                  ifelse( d_2006$F21F91 == 2, "Homosexual",
                                                          ifelse( d_2006$F21F91 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2006$sexual_identity_2021, useNA = "always" )

# sex
table( d_2006$kon, useNA = "always" )
d_2006$sex <- factor( ifelse( d_2006$kon == 1, "Male", "Female" ),
                      levels = c( "Male", "Female" ) )
table( d_2006$sex, useNA = "always" )

# age
summary( d_2006$F6alder )
d_2006$age_2006 <- d_2006$F6alder
d_2006$age_2010 <- d_2006$age_2006 + 4
d_2006$age_2010_cat <- factor( ifelse( d_2006$age_2010 <= 29, "16-29", 
                                       ifelse( d_2006$age_2010 >=30 & d_2006$age_2010 <= 44, "30-44",
                                               ifelse( d_2006$age_2010 >= 45 & d_2006$age_2010 <= 59, "45-59", ">=60" ) ) ),
                               levels = c( "16-29", "30-44", "45-59", ">=60" ) )
table( d_2006$age_2010_cat, useNA = "always" )

# country of birth
table( d_2006$fodelseland, useNA = "always" )
d_2006$country_of_birth <- factor( ifelse( d_2006$fodelseland == "Afrika", "Africa",
                                           ifelse( d_2006$fodelseland == "Asien", "Asia",
                                                   ifelse( d_2006$fodelseland == "Europa", "Europe",
                                                           ifelse( d_2006$fodelseland == "Sverige", "Sweden", "Americas" ) ) ) ),
                                   levels = c( "Africa", "Americas", "Asia", "Europe", "Sweden" ) )
table( d_2006$country_of_birth, useNA = "always" )

# sampling strata
n_miss( d_2006$stratum )
d_2006$sampling_strata <- as.factor( d_2006$stratum )
length( unique( d_2006$sampling_strata ) ) # 43 strata

strata_region_name <- readxl::read_xlsx("/Users/guoqiang.zhang/Documents/Karolinska Institutet/Research Projects/SPHC/Data for LGB projects/Stratum.xlsx")

strata_region_name$region_2006 <- as.factor( strata_region_name$region_2006 )

d_2006 <- d_2006 %>% 
  left_join( strata_region_name[ , c( 2, 6 ) ], by = c( "sampling_strata" = "region_2006" ) )

d_2006$sampling_strata_region <- d_2006$sdk_2006


##### design weights #####

summary( d_2006$F6dvikt )
d_2006$design_weight <- d_2006$F6dvikt


##### non-response #####

# unit non-response
d_2006$design_weight_unit_nonresponse <- d_2006$F6dbvikt # weights calculated assuming Missing Completely At Random (MCAR) within each stratum
summary( d_2006$design_weight_unit_nonresponse )
sum( d_2006$design_weight_unit_nonresponse ) # No. of source population = 1,450,501

unitresponse_prob <- d_2006 %>% 
  group_by( sampling_strata_region ) %>% 
  summarise( unitresponse_prob = unique( design_weight ) / unique( design_weight_unit_nonresponse ),
             no.of.population = sum( design_weight_unit_nonresponse ),
             sample_size = unique( no.of.population )/unique( design_weight ) ) # calculate overall unit response rate, and no. of population and sample size within each stratum
d_2006 <- d_2006 %>% 
  left_join( unitresponse_prob, by = "sampling_strata_region" )

# item non-response
itemresponse_prob <- d_2006 %>% 
  group_by( sampling_strata_region ) %>% 
  summarise( itemresponse_prob = sum( !is.na( sexual_identity_2010 ) ) / n() ) # calculate item response rate

d_2006 <- d_2006 %>% 
  left_join( itemresponse_prob, by = "sampling_strata_region" ) %>% 
  mutate( itemresponse_prob = ifelse( is.na( sexual_identity_2010 ), 0, itemresponse_prob ) )


##### summary of stratified sampling #####

sampling_frame_2006 <- as.data.frame( d_2006 %>% 
                                        group_by( sampling_strata_region ) %>% 
                                        reframe( no.of.population = unique( no.of.population ), 
                                                 sample_size = unique( no.of.population/design_weight ),
                                                 unitresponse = n(),
                                                 itemresponse = sum( itemresponse_prob != 0 ) ) )

sampling_frame_2006 <- sampling_frame_2006 %>% 
  left_join( strata_region_name[ , c( 2, 6 ) ], by = c( "sampling_strata_region" = "sdk_2006" ) ) %>%
  arrange( region_2006 )

sampling_frame_2006$unitresponse_rate <- sampling_frame_2006$unitresponse/sampling_frame_2006$sample_size
sampling_frame_2006$itemresponse_rate <- sampling_frame_2006$itemresponse/sampling_frame_2006$unitresponse
sampling_frame_2006$overallresponse_rate <- sampling_frame_2006$itemresponse/sampling_frame_2006$sample_size

sampling_frame_2006$unitresponse_label <- paste0( sampling_frame_2006$unitresponse, " (", 
                                                  sprintf( "%.1f", sampling_frame_2006$unitresponse_rate*100 ), "%)" )
sampling_frame_2006$overallresponse_label <- paste0( sampling_frame_2006$itemresponse, " (", 
                                                     sprintf( "%.1f", sampling_frame_2006$overallresponse_rate*100 ), "%)" )

round( sum( sampling_frame_2006$unitresponse )/( sum( sampling_frame_2006$sample_size ) ), 3 ) # overall unit response rate
round( sum( sampling_frame_2006$itemresponse )/( sum( sampling_frame_2006$unitresponse ) ), 3 ) # overall item response rate
round( sum( sampling_frame_2006$itemresponse )/( sum( sampling_frame_2006$sample_size ) ), 3 ) # overall response rate

writexl::write_xlsx( sampling_frame_2006, "sampling_frame_2006.xlsx" )
```

#### 2.3. SPHC-B 2010 with SPHC-F 2014-2021
```{r}
load("/Volumes/LGBT Project data/d_2010.RData")

# sexual identity in 2010
table( d_2010$F10U87G78, useNA = "always" )
d_2010$F10U87G78[ d_2010$F10U87G78 == 9 ] <- NA
d_2010$sexual_identity_2010 <- factor( ifelse( d_2010$F10U87G78 == 1, "Heterosexual",
                                                  ifelse( d_2010$F10U87G78 == 2, "Homosexual",
                                                          ifelse( d_2010$F10U87G78 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2010$sexual_identity_2010, useNA = "always" )

# sexual identity in 2014
table( d_2010$F14F103, useNA = "always" )
d_2010$sexual_identity_2014 <- factor( ifelse( d_2010$F14F103 == 1, "Heterosexual",
                                                  ifelse( d_2010$F14F103 == 2, "Homosexual",
                                                          ifelse( d_2010$F14F103 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2010$sexual_identity_2014, useNA = "always" )

# sexual identity in 2021
table( d_2010$F21F91, useNA = "always" )
d_2010$sexual_identity_2021 <- factor( ifelse( d_2010$F21F91 == 1, "Heterosexual",
                                                  ifelse( d_2010$F21F91 == 2, "Homosexual",
                                                          ifelse( d_2010$F21F91 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2010$sexual_identity_2021, useNA = "always" )

# sex
table( d_2010$kon, useNA = "always" )
d_2010$sex <- factor( ifelse( d_2010$kon == 1, "Male", "Female" ),
                      levels = c( "Male", "Female" ) )
table( d_2010$sex, useNA = "always" )

# age
summary( d_2010$F10alder )
d_2010$age_2010 <- d_2010$F10alder
d_2010$age_2010_cat <- factor( ifelse( d_2010$age_2010 <= 29, "16-29", 
                                       ifelse( d_2010$age_2010 >=30 & d_2010$age_2010 <= 44, "30-44",
                                               ifelse( d_2010$age_2010 >= 45 & d_2010$age_2010 <= 59, "45-59", ">=60" ) ) ),
                               levels = c( "16-29", "30-44", "45-59", ">=60" ) )
table( d_2010$age_2010_cat, useNA = "always" )

# country of birth
table( d_2010$fodelseland, useNA = "always" )
d_2010$country_of_birth <- factor( ifelse( d_2010$fodelseland == "Afrika", "Africa",
                                           ifelse( d_2010$fodelseland == "Asien", "Asia",
                                                   ifelse( d_2010$fodelseland == "Europa", "Europe",
                                                           ifelse( d_2010$fodelseland == "Sverige", "Sweden", "Americas" ) ) ) ),
                                   levels = c( "Africa", "Americas", "Asia", "Europe", "Sweden" ) )
table( d_2010$country_of_birth, useNA = "always" )

# education
table( d_2010$utbniva2010, useNA = "always" )
d_2010$education <- factor( ifelse( d_2010$utbniva2010 <= 2, "<=9 years",
                                    ifelse( d_2010$utbniva2010 <= 4, "10-12 years", ">=13 years" ) ), 
                            levels = c( "<=9 years", "10-12 years", ">=13 years" ) )
table( d_2010$education, useNA = "always" )

# disposable income
summary( d_2010$dispink2010, useNA = "always" )
d_2010$dispink2010 <- d_2010$dispink2010*( 1960/1733 ) # Consumer Price Index (CPI)-adjusted income
d_2010$income <- factor( ifelse( d_2010$dispink2010 <= 2500, "<=2,500",
                                 ifelse( d_2010$dispink2010 > 2500 & d_2010$dispink2010 <= 3500, "(2,500, 3,500]",
                                         ifelse( d_2010$dispink2010 > 3500 & d_2010$dispink2010 <= 4500, "(3,500, 4,500]", ">4,500" ) ) ),
                         levels = c( "<=2,500", "(2,500, 3,500]", "(3,500, 4,500]", ">4,500" ) )
table( d_2010$income, useNA = "always" )

# marital status
table( d_2010$civil2010, useNA = "always" )
d_2010$marital_status <- factor( ifelse( d_2010$civil2010 == "G" | d_2010$civil2010 == "RP", "Currently married",
                                         ifelse( d_2010$civil2010 == "OG", "Never married", "Other" ) ), 
                                 levels = c( "Never married", "Currently married", "Other" ) )
table( d_2010$marital_status, useNA = "always" )

# living alone
table( d_2010$F10U53aG57a, useNA = "always" )
d_2010$F10U53aG57a[ d_2010$F10U53aG57a == 9 ] <- NA
d_2010$living_alone <- factor( ifelse( d_2010$F10U53aG57a == 1, "no", "yes" ), 
                               levels = c( "yes", "no" ) )
table( d_2010$living_alone, useNA = "always" )

# personal support
table( d_2010$F10U57G62, useNA = "always" )
d_2010$F10U57G62[ d_2010$F10U57G62 == 9 ] <- NA
d_2010$personal_support <- factor( ifelse( d_2010$F10U57G62 <= 2, "yes", "no" ), 
                                   levels = c( "yes", "no" ) )
table( d_2010$personal_support, useNA = "always" )

# sampling strata
n_miss( d_2010$stratum )
d_2010$sampling_strata <- as.factor( d_2010$stratum )
length( unique( d_2010$sampling_strata ) ) # 39 strata

strata_region_name$region_2010 <- as.factor( strata_region_name$region_2010 )

d_2010 <- d_2010 %>% 
  left_join( strata_region_name[ , c( 3, 7 ) ], by = c( "sampling_strata" = "region_2010" ) )

d_2010$sampling_strata_region <- d_2010$sdk_2010
```

#### 2.4. Merge data across surveys
```{r}
##### obtain follow-up data in 2010-2021 for SPHC-B 2002 and 2006 #####

# there are 999 individuals who participated in both SPHC-B 2002 and 2006
# their follow-up data are included only once

# 114 of the 999 individuals changed place of residence between 2002 and 2006
# their place of residence in 2006 is used for analysis

variable_list <- c( "lopnr", "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021", "age_2010", "sex", "country_of_birth", "sampling_strata_region" )
  
m1 <- d_2002[ , variable_list ] %>%
  mutate( year = rep( "SPHC 2002" ) )

m2 <- d_2006[ , variable_list ] %>%
  mutate( year = rep( "SPHC 2006" ) )

m12 <- rbind( m1, m2 ) %>%
  group_by( lopnr ) %>%
  filter( !( year == "SPHC 2002" & any( year == "SPHC 2006" ) ) ) %>%
  ungroup()

sphcf10 <- read_sas( "/Volumes/LGBT Project data/sphc-f10.sas7bdat",
                     col_select = c( "lopnr", "utbniva2010", "dispink2010", "civil2010", "F10F80a", "F10F84" ) )

m12_updated <- sphcf10 %>%
  left_join( m12, by = "lopnr" )

# age
summary( m12_updated$age_2010 )
m12_updated$age_conf <- m12_updated$age_2010
m12_updated$age_exp <- factor( ifelse( m12_updated$age_2010 <= 29, "<=29", 
                                       ifelse( m12_updated$age_2010 >=30 & m12_updated$age_2010 <= 44, "30-44",
                                               ifelse( m12_updated$age_2010 >= 45 & m12_updated$age_2010 <= 59, "45-59", ">=60" ) ) ),
                               levels = c( "45-59", "<=29", "30-44", ">=60" ) )
table( m12_updated$age_exp, useNA = "always" )

# sex
summary( m12_updated$sex )
m12_updated$sex_exp <-relevel( m12_updated$sex, ref = "Male" )
m12_updated$sex_conf <- m12_updated$sex

# country of birth
summary( m12_updated$country_of_birth )
m12_updated$country_of_birth_conf <- m12_updated$country_of_birth
m12_updated$country_of_birth_exp <- factor( ifelse( m12_updated$country_of_birth == "Sweden", "Sweden",
                                                    ifelse( m12_updated$country_of_birth == "Europe", "Europe", "Outside Europe" ) ),
                                            levels = c( "Sweden", "Europe", "Outside Europe" ) )
table( m12_updated$country_of_birth_exp, useNA = "always" )

# education
table( m12_updated$utbniva2010, useNA = "always" )
m12_updated$education_conf <- as.factor( m12_updated$utbniva2010 )
m12_updated$education_exp <- factor( ifelse( m12_updated$utbniva2010 <= 2, "<=9 years",
                                             ifelse( m12_updated$utbniva2010 <= 4, "10-12 years", ">=13 years" ) ), 
                                     levels = c( ">=13 years", "<=9 years", "10-12 years" ) )
table( m12_updated$education_exp, useNA = "always" )

# disposable income
summary( m12_updated$dispink2010, useNA = "always" )
m12_updated$dispink2010 <- m12_updated$dispink2010*( 1960/1733 ) # Consumer Price Index (CPI)-adjusted income
m12_updated$income_conf <- m12_updated$dispink2010
m12_updated$income_exp <- factor( ifelse( m12_updated$dispink2010 <= 2500, "<=2,500",
                                          ifelse( m12_updated$dispink2010 > 2500 & m12_updated$dispink2010 <= 3500, "(2,500, 3,500]",
                                                  ifelse( m12_updated$dispink2010 > 3500 & m12_updated$dispink2010 <= 4500, "(3,500, 4,500]", ">4,500" ) ) ),
                                  levels = c( ">4,500", "<=2,500", "(2,500, 3,500]", "(3,500, 4,500]" ) )
table( m12_updated$income_exp, useNA = "always" )

# marital status
table( m12_updated$civil2010, useNA = "always" )
m12_updated$civil2010[ m12_updated$civil2010 == "" ] <- NA
m12_updated$marital_status_exp <- factor( ifelse( m12_updated$civil2010 == "G" | m12_updated$civil2010 == "RP", "Currently married",
                                                  ifelse( m12_updated$civil2010 == "OG", "Never married", "Other" ) ), 
                                          levels = c( "Currently married", "Never married", "Other" ) )
m12_updated$marital_status_conf <- m12_updated$marital_status_exp
table( m12_updated$marital_status_exp, useNA = "always" )

# living alone
table( m12_updated$F10F80a, useNA = "always" )
m12_updated$living_status_conf <- as.factor( m12_updated$F10F80a )
m12_updated$living_status_exp <- factor( ifelse( m12_updated$F10F80a == 1, "no", "yes" ), 
                                         levels = c( "no", "yes" ) )
table( m12_updated$living_status_exp, useNA = "always" )

# personal support
table( m12_updated$F10F84, useNA = "always" )
m12_updated$personal_support_conf <- as.factor( m12_updated$F10F84 )
m12_updated$personal_support_exp <- factor( ifelse( m12_updated$F10F84 <= 2, "yes", "no" ), 
                                            levels = c( "yes", "no" ) )
table( m12_updated$personal_support_exp, useNA = "always" )

# place of residence
m12_updated$place_of_residence_conf <- as.factor( m12_updated$sampling_strata_region )

# year
table( m12_updated$year, useNA = "always" )
m12_updated$year_conf <- as.factor( m12_updated$year )
m12_updated$year_exp <- factor( m12_updated$year, levels = c( "SPHC 2002", "SPHC 2006" ) )

summary( m12_updated )
d_2002_2006_follow_up <- m12_updated %>%
  select( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021", "age_exp", "age_conf", "sex_exp", "sex_conf", "country_of_birth_exp", "country_of_birth_conf", "education_exp", "education_conf", "income_exp", "income_conf", "marital_status_exp", "marital_status_conf", "living_status_exp", "living_status_conf", "personal_support_exp", "personal_support_conf", "place_of_residence_conf", "year_exp", "year_conf" )


##### obtain follow-up data in 2010-2021 for SPHC-B 2010 #####

d_2010 <- d_2010 %>% mutate( year = rep( "SPHC 2010" ) )

# age
summary( d_2010$age_2010 )
d_2010$age_conf <- d_2010$age_2010
d_2010$age_exp <- factor( ifelse( d_2010$age_2010 <= 29, "<=29", 
                              ifelse( d_2010$age_2010 >=30 & d_2010$age_2010 <= 44, "30-44",
                                      ifelse( d_2010$age_2010 >= 45 & d_2010$age_2010 <= 59, "45-59", ">=60" ) ) ),
                      levels = c( "45-59", "<=29", "30-44", ">=60" ) )
table( d_2010$age_exp, useNA = "always" )

# sex
summary( d_2010$sex )
d_2010$sex_conf <- d_2010$sex
d_2010$sex_exp <- relevel( d_2010$sex, ref = "Male" )

# country of birth
summary( d_2010$country_of_birth )
d_2010$country_of_birth_conf <- d_2010$country_of_birth
d_2010$country_of_birth_exp <- factor( ifelse( d_2010$country_of_birth == "Sweden", "Sweden",
                                               ifelse( d_2010$country_of_birth == "Europe", "Europe", "Outside Europe" ) ),
                                       levels = c( "Sweden", "Europe", "Outside Europe" ) )

# education
table( d_2010$utbniva2010, useNA = "always" )
summary( d_2010$education )
d_2010$education_conf <- as.factor( d_2010$utbniva2010 )
d_2010$education_exp <- relevel( d_2010$education, ref = ">=13 years" )

# disposable income
summary( d_2010$dispink2010 )
summary( d_2010$income )
d_2010$income_conf <- d_2010$dispink2010
d_2010$income_exp <- relevel( d_2010$income, ref = ">4,500" )

# marital status
summary( d_2010$marital_status )
d_2010$marital_status_conf <- d_2010$marital_status
d_2010$marital_status_exp <- relevel( d_2010$marital_status, ref = "Currently married" )

# living alone
table( d_2010$F10U53aG57a, useNA = "always" )
d_2010$F10U53aG57a[ d_2010$F10U53aG57a == 9 ] <- NA
summary( d_2010$living_alone )
d_2010$living_status_conf <- as.factor( d_2010$F10U53aG57a )
d_2010$living_status_exp <- relevel( d_2010$living_alone, ref = "no" )

# personal support
table( d_2010$F10U57G62, useNA = "always" )
d_2010$F10U57G62[ d_2010$F10U57G62 == 9 ] <- NA
summary( d_2010$personal_support )
d_2010$personal_support_conf <- as.factor( d_2010$F10U57G62 )
d_2010$personal_support_exp <- relevel( d_2010$personal_support, ref = "yes" )

# place of residence
d_2010$place_of_residence_conf <- as.factor( d_2010$sampling_strata_region )

# year
table( d_2010$year, useNA = "always" )
d_2010$year_conf <- as.factor( d_2010$year )
d_2010$year_exp <- as.factor( d_2010$year )

summary( d_2010 )
d_2010_follow_up <- d_2010 %>%
  select( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021", "age_exp", "age_conf", "sex_exp", "sex_conf", "country_of_birth_exp", "country_of_birth_conf", "education_exp", "education_conf", "income_exp", "income_conf", "marital_status_exp", "marital_status_conf", "living_status_exp", "living_status_conf", "personal_support_exp", "personal_support_conf", "place_of_residence_conf", "year_exp", "year_conf" )


##### merge follow-up data in 2010-2021 for SPHC-B 2002, 2006, and 2010 #####

d_2002_2006_2010_follow_up <- rbind( d_2002_2006_follow_up, d_2010_follow_up )

# define outcome
d_2002_2006_2010_follow_up$sexual_identity_fluidity <- ifelse(
    d_2002_2006_2010_follow_up$sexual_identity_2010 != d_2002_2006_2010_follow_up$sexual_identity_2014 | 
    d_2002_2006_2010_follow_up$sexual_identity_2010 != d_2002_2006_2010_follow_up$sexual_identity_2021 |
    d_2002_2006_2010_follow_up$sexual_identity_2014 != d_2002_2006_2010_follow_up$sexual_identity_2021, 
    1, 0 ) # any change of sexual identity in 2010-2021

d_sexual_identity_fluidity <- d_2002_2006_2010_follow_up[ 
  !is.na( d_2002_2006_2010_follow_up$sexual_identity_2010 ) &
    !is.na( d_2002_2006_2010_follow_up$sexual_identity_2014 ) &
    !is.na( d_2002_2006_2010_follow_up$sexual_identity_2021 ), c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021", "age_exp", "sex_exp" ) ]
nrow( d_sexual_identity_fluidity ) # 34,815 provided data on sexual identity in 2010-2021

# calculate the number of people who changed their sexual identity at least once
changed_once <- sum(
  d_sexual_identity_fluidity$sexual_identity_2010 != d_sexual_identity_fluidity$sexual_identity_2014 | 
  d_sexual_identity_fluidity$sexual_identity_2010 != d_sexual_identity_fluidity$sexual_identity_2021 |
  d_sexual_identity_fluidity$sexual_identity_2014 != d_sexual_identity_fluidity$sexual_identity_2021
)

# calculate the number of people who changed their sexual identity twice
changed_twice <- sum(
  d_sexual_identity_fluidity$sexual_identity_2010 != d_sexual_identity_fluidity$sexual_identity_2014 &
  d_sexual_identity_fluidity$sexual_identity_2014 != d_sexual_identity_fluidity$sexual_identity_2021
)


d_fluidity_model <- subset( d_2002_2006_2010_follow_up, 
                            select = -c( sexual_identity_2014, sexual_identity_2021 ) ) %>%
  filter( !is.na( sexual_identity_fluidity ) )
miss_case_summary( d_fluidity_model ) # no cases had missing data on all variables
nrow( d_fluidity_model ) # 36,398 participants with (incomplete) follow-up data on demographic variables

# sexual identity in 2010
summary( d_fluidity_model$sexual_identity_2010 )
d_fluidity_model$sexual_identity_2010_exp <- relevel( d_fluidity_model$sexual_identity_2010, ref = "Heterosexual" )
d_fluidity_model$sexual_identity_2010_conf <- d_fluidity_model$sexual_identity_2010


# make characteristics table by changes in sexual identity
explanatory =  c( "year_exp", "sex_exp", "age_exp", "country_of_birth_exp", "education_exp", "income_exp", "marital_status_exp", "living_status_exp", "personal_support_exp", "sexual_identity_2010" )
dependent = "sexual_identity_fluidity"

d_follow_up_table <- d_fluidity_model %>% 
  mutate( sexual_identity_fluidity = factor( sexual_identity_fluidity, levels = c( 0, 1 ), labels = c( "no change", "change" ) ) ) %>%
  summary_factorlist( dependent,
                      explanatory, 
                      na_include = TRUE,
                      total_col = TRUE,
                      add_col_totals = TRUE,
                      column = FALSE )

# Fisher's test
x1 <- table( d_fluidity_model$year_exp, d_fluidity_model$sexual_identity_fluidity )
x1
format( round( fisher.test( x1, simulate.p.value = TRUE )$p.value, 3 ), nsmall = 3 )

x2 <- table( d_fluidity_model$sex_exp, d_fluidity_model$sexual_identity_fluidity )
x2
format( round( fisher.test( x2 )$p.value, 3 ), nsmall = 3 )

x3 <- table( d_fluidity_model$age_exp, d_fluidity_model$sexual_identity_fluidity )
x3
format( round( fisher.test( x3, simulate.p.value = TRUE )$p.value, 3 ), nsmall = 3 )

x4 <- table( d_fluidity_model$country_of_birth_exp, d_fluidity_model$sexual_identity_fluidity )
x4
format( round( fisher.test( x4, simulate.p.value = TRUE )$p.value, 3 ), nsmall = 3 )

x5 <- table( d_fluidity_model$education_exp, d_fluidity_model$sexual_identity_fluidity )
x5
format( round( fisher.test( x5, simulate.p.value = TRUE )$p.value, 3 ), nsmall = 3 )

x6 <- table( d_fluidity_model$income_exp, d_fluidity_model$sexual_identity_fluidity )
x6
format( round( fisher.test( x6, simulate.p.value = TRUE )$p.value, 3 ), nsmall = 3 )

x7 <- table( d_fluidity_model$marital_status_exp, d_fluidity_model$sexual_identity_fluidity )
x7
format( round( fisher.test( x7, simulate.p.value = TRUE )$p.value, 3 ), nsmall = 3 )

x8 <- table( d_fluidity_model$living_status_exp, d_fluidity_model$sexual_identity_fluidity )
x8
format( round( fisher.test( x8, simulate.p.value = TRUE )$p.value, 3 ), nsmall = 3 )

x9 <- table( d_fluidity_model$personal_support_exp, d_fluidity_model$sexual_identity_fluidity )
x9
format( round( fisher.test( x9, simulate.p.value = TRUE )$p.value, 3 ), nsmall = 3 )

x10 <- table( d_fluidity_model$sexual_identity_2010, d_fluidity_model$sexual_identity_fluidity )
x10
format( round( fisher.test( x10, simulate.p.value = TRUE )$p.value, 3 ), nsmall = 3 )
```

### 3. Make Fluidity Plots
#### 3.1. Prepare dataset for plotting
##### 3.1.1. Among all participants
```{r}
# changes in sexual identity from 2010 to 2021
m123_all <- d_sexual_identity_fluidity %>%
  count( sexual_identity_2010, sexual_identity_2014, sexual_identity_2021, name = "number" ) %>%
  mutate( percent = number / sum( number ) )

m123_all <- m123_all %>%
  group_by( sexual_identity_2010 ) %>%
  mutate( percent_for_label = number / sum( number ) ) %>%
  ungroup()

m123_all$label <- paste0( prettyNum( m123_all$number, big.mark = "," , preserve.width = "none" ), 
                          " (", sprintf( "%.1f", m123_all$percent_for_label*100 ), "%)" 
                          )

for ( col in 1:3 ) {
  m123_all[[col]] <- factor( m123_all[[col]], levels = c( "Homosexual", "Bisexual", "Other", "Heterosexual" ) ) 
}

m123_all_long <- to_lodes_form( m123_all, axes = 1:3, key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010 ) # convert to long format


# changes in sexual identity from 2010-2014 to 2021
x123_all <- d_sexual_identity_fluidity %>%
  count( sexual_identity_2010, sexual_identity_2014, sexual_identity_2021, name = "number" ) %>%
  mutate( sexual_identity_2010_2014 = paste( sexual_identity_2010, 
                                             sexual_identity_2014, 
                                             sep = "_"
                                             ) )

x123_all$percent <- x123_all$number/sum( x123_all$number )

ordered_levels <- x123_all %>%
  group_by( sexual_identity_2010_2014 ) %>%
  summarize( total = sum( number ) ) %>%
  arrange( desc( total ) ) %>%
  pull( sexual_identity_2010_2014 )

ordered_levels <- as.character( ordered_levels[ ordered_levels != "Heterosexual_Heterosexual" & 
                                                  ordered_levels != "Heterosexual_Other" ] )
ordered_levels <- c( ordered_levels, "Heterosexual_Other", "Heterosexual_Heterosexual" )

x123_all$sexual_identity_2010_2014 <- factor( x123_all$sexual_identity_2010_2014,
                                              levels = ordered_levels )

x123_all$sexual_identity_2021 <- factor( x123_all$sexual_identity_2021,
                                         levels = c( "Homosexual", "Bisexual", "Other", "Heterosexual" )
                                         )

x123_all <- x123_all %>%
  group_by( sexual_identity_2010_2014 ) %>%
  mutate( total = sum( number ) ) %>%
  mutate( percent_for_label = number / total ) %>%
  ungroup()

x123_all$label <- paste0( prettyNum( x123_all$number, big.mark = "," , preserve.width = "none" ), 
                          " (", 
                          sprintf( "%.1f", x123_all$percent_for_label*100 ),
                          "%)" )

x123_all_long <- to_lodes_form( x123_all, axes = c( 5, 3 ), key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010_2014 )
```

##### 3.1.2. By sex
```{r}
m123_sex <- d_sexual_identity_fluidity %>%
  count( sexual_identity_2010, sexual_identity_2014, sexual_identity_2021, sex_exp ) %>%
  rename( number = n )

m123_sex <- m123_sex %>%
  group_by( sex_exp ) %>%
  mutate( percent = number / sum( number ) ) %>%
  ungroup()

for ( col in 1:3 ) {
  m123_sex[[col]] <- factor( m123_sex[[col]], levels = c( "Homosexual", "Bisexual", "Other", "Heterosexual" ) ) 
}

# among males
m123_male <- m123_sex %>%
  filter( sex_exp == "Male" ) %>%
  group_by( sexual_identity_2010 ) %>%
  mutate( percent_for_label = number / sum( number ) ) %>%
  ungroup()

m123_male$label <- paste0( prettyNum( m123_male$number, big.mark = "," , preserve.width = "none" ), " (", 
                          sprintf( "%.1f", m123_male$percent_for_label*100 ),
                          "%)" )

m123_male_long <- to_lodes_form( m123_male, axes = 1:3, key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010 )


# among females
m123_female <- m123_sex %>%
  filter( sex_exp == "Female" ) %>%
  group_by( sexual_identity_2010 ) %>%
  mutate( percent_for_label = number / sum( number ) ) %>%
  ungroup()

m123_female$label <- paste0( prettyNum( m123_female$number, big.mark = "," , preserve.width = "none" ), " (", 
                          sprintf( "%.1f", m123_female$percent_for_label*100 ),
                          "%)" )

m123_female_long <- to_lodes_form( m123_female, axes = 1:3, key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010 )
```

##### 3.1.3. By age
```{r}
summary( d_sexual_identity_fluidity$age_exp )

m123_age <- d_sexual_identity_fluidity %>%
  count( sexual_identity_2010, sexual_identity_2014, sexual_identity_2021, age_exp ) %>%
  rename( number = n ) %>%
  group_by( age_exp ) %>%
  mutate( percent = number / sum( number ) ) %>%
  ungroup()

for ( col in 1:3 ) {
  m123_age[[col]] <- factor( m123_age[[col]], levels = c( "Homosexual", "Bisexual", "Other", "Heterosexual" ) ) 
}


# 18-29 yrs
m123_age_18 <- m123_age %>%
  filter( age_exp == "<=29" ) %>%
  group_by( sexual_identity_2010 ) %>%
  mutate( percent_for_label = number / sum( number ) ) %>%
  ungroup()

m123_age_18$label <- paste0( prettyNum( m123_age_18$number, big.mark = "," , preserve.width = "none" ), " (", 
                          sprintf( "%.1f", m123_age_18$percent_for_label*100 ),
                          "%)" )

m123_age_18_long <- to_lodes_form( m123_age_18, axes = 1:3, key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010 )


# 30-44 yrs
m123_age_30 <- m123_age %>%
  filter( age_exp == "30-44" ) %>%
  group_by( sexual_identity_2010 ) %>%
  mutate( percent_for_label = number / sum( number ) ) %>%
  ungroup()

m123_age_30$label <- paste0( prettyNum( m123_age_30$number, big.mark = "," , preserve.width = "none" ), " (", 
                          sprintf( "%.1f", m123_age_30$percent_for_label*100 ),
                          "%)" )

m123_age_30_long <- to_lodes_form( m123_age_30, axes = 1:3, key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010 )


# 45-59 yrs
m123_age_45 <- m123_age %>%
  filter( age_exp == "45-59" ) %>%
  group_by( sexual_identity_2010 ) %>%
  mutate( percent_for_label = number / sum( number ) ) %>%
  ungroup()

m123_age_45$label <- paste0( prettyNum( m123_age_45$number, big.mark = "," , preserve.width = "none" ), " (", 
                          sprintf( "%.1f", m123_age_45$percent_for_label*100 ),
                          "%)" )

m123_age_45_long <- to_lodes_form( m123_age_45, axes = 1:3, key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010 )


# >=60 yrs
m123_age_60 <- m123_age %>%
  filter( age_exp == ">=60" ) %>%
  group_by( sexual_identity_2010 ) %>%
  mutate( percent_for_label = number / sum( number ) ) %>%
  ungroup()

m123_age_60$label <- paste0( prettyNum( m123_age_60$number, big.mark = "," , preserve.width = "none" ), " (", 
                          sprintf( "%.1f", m123_age_60$percent_for_label*100 ),
                          "%)" )

m123_age_60_long <- to_lodes_form( m123_age_60, axes = 1:3, key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010 )
```

#### 3.2. Plotting
##### 3.2.1. Among all participants
###### 3.2.1.1. Changes in sexual identity from 2010 to 2021
```{r}
ggplot( m123_all_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  geom_alluvium( aes( fill = sexual_identity_2010 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010 ) ) +
  geom_text( stat = "stratum", aes( label = after_stat( stratum ) ), family = "Arial", size = 12 / .pt ) +
  scale_fill_manual( values = c( "#C77CFF", "#00BFC4", "#7CAE00", "#F8766D" ),
                     breaks = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ),
                     na.value = NA ) +
  scale_x_discrete( limits = c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021" ), labels = c( "2010", "2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.9 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
         ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = factor( sexual_identity_2010, 
                                        levels = c( "Other", "Bisexual", "Homosexual", "Heterosexual" ) ),
                        label = ifelse( year == "sexual_identity_2021" & 
                                          ( percent_for_label >= 0.1 | number >= 50 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.45,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
                   )
```

###### 3.2.1.2. Sexual identity in 2021 based on 2010 and 2014
```{r}
all_colors <- c( "#00BFC4", "#7CAE00", "#FFA500", "#F8766D", 
                 "yellow2", "#0092FF", "#00FF00", "#4B0082", 
                 "#0000FF", "#DEB887", "#00A86B", "#FF0000", 
                 "#FF00DB", "#E6E6FA", "#87CEEB", "#C77CFF" )

legend_labels <- setNames(
  c( "Homo to Homo", "Bisexual to bisexual", "Hetero to bisexual", "Uncertain to other",
     "Homo to Hetero", "Bisexual to Hetero", "Uncertain to Hetero", "Bisexual to other",
     "Hetero to Homo", "Uncertain to bisexual", "Bisexual to Homo", "Homo to bisexual",
     "Homo to other", "Uncertain to Homo", "Hetero to other", "Hetero to Hetero"),
  ordered_levels )

ggplot( x123_all_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  
  geom_alluvium( aes( fill = sexual_identity_2010_2014 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010_2014 ) ) +
  
  geom_text( data = subset( x123_all_long, year == "sexual_identity_2021"), 
             stat = "stratum", 
             aes( label = after_stat( stratum ) ), 
             family = "Arial", 
             size = 12 / .pt ) +
  
  scale_fill_manual( values = all_colors,
                     breaks = ordered_levels,
                     labels = legend_labels,
                     na.value = NA ) +
  
  scale_x_discrete( limits = c( "sexual_identity_2010_2014", "sexual_identity_2021" ), labels = c( "2010â€“2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.9 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
  ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = sexual_identity_2010_2014,
                        label = ifelse( year == "sexual_identity_2021" & 
                                          ( percent_for_label >= 0.05 & number >= 25 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.45,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
  ) +
  scale_color_manual( values = all_colors,
                      breaks = ordered_levels )
```

##### 3.2.2. By sex
```{r}
# among males
ggplot( m123_male_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  geom_alluvium( aes( fill = sexual_identity_2010 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010 ) ) +
  geom_text( stat = "stratum", aes( label = after_stat( stratum ) ), family = "Arial", size = 12 / .pt ) +
  scale_fill_manual( values = c( "#C77CFF", "#00BFC4", "#7CAE00", "#F8766D" ),
                     breaks = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ),
                     na.value = NA ) +
  scale_x_discrete( limits = c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021" ), labels = c( "2010", "2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.9 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
         ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = factor( sexual_identity_2010, levels = c( "Other", "Bisexual", "Homosexual", "Heterosexual" ) ),
                        label = ifelse( year == "sexual_identity_2021" & ( percent_for_label >= 0.1 | number >= 15 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.25,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
                   )


# among females
ggplot( m123_female_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  geom_alluvium( aes( fill = sexual_identity_2010 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010 ) ) +
  geom_text( stat = "stratum", aes( label = after_stat( stratum ) ), family = "Arial", size = 12 / .pt ) +
  scale_fill_manual( values = c( "#C77CFF", "#00BFC4", "#7CAE00", "#F8766D" ),
                     breaks = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ),
                     na.value = NA ) +
  scale_x_discrete( limits = c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021" ), labels = c( "2010", "2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.9 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
         ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = factor( sexual_identity_2010, levels = c( "Other", "Bisexual", "Homosexual", "Heterosexual" ) ),
                        label = ifelse( year == "sexual_identity_2021" & ( percent_for_label >= 0.1 | number >= 30 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.25,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
                   )
```

##### 3.2.3. By age
```{r}
# 18-29 years 
ggplot( m123_age_18_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  geom_alluvium( aes( fill = sexual_identity_2010 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010 ) ) +
  geom_text( stat = "stratum", aes( label = after_stat( stratum ) ), family = "Arial", size = 12 / .pt ) +
  scale_fill_manual( values = c( "#C77CFF", "#00BFC4", "#7CAE00", "#F8766D" ),
                     breaks = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ),
                     na.value = NA ) +
  scale_x_discrete( limits = c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021" ), labels = c( "2010", "2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.86 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
         ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = factor( sexual_identity_2010, levels = c( "Other", "Bisexual", "Homosexual", "Heterosexual" ) ),
                        label = ifelse( year == "sexual_identity_2021" & ( percent_for_label >= 0.1 | number >= 6 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.25,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
                   )


# 30-44 years
ggplot( m123_age_30_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  geom_alluvium( aes( fill = sexual_identity_2010 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010 ) ) +
  geom_text( stat = "stratum", aes( label = after_stat( stratum ) ), family = "Arial", size = 12 / .pt ) +
  scale_fill_manual( values = c( "#C77CFF", "#00BFC4", "#7CAE00", "#F8766D" ),
                     breaks = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ),
                     na.value = NA ) +
  scale_x_discrete( limits = c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021" ), labels = c( "2010", "2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.91 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
         ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = factor( sexual_identity_2010, levels = c( "Other", "Bisexual", "Homosexual", "Heterosexual" ) ),
                        label = ifelse( year == "sexual_identity_2021" & ( percent_for_label >= 0.1 | number >= 12 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.25,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
                   )


# 45-59 years
ggplot( m123_age_45_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  geom_alluvium( aes( fill = sexual_identity_2010 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010 ) ) +
  geom_text( stat = "stratum", aes( label = after_stat( stratum ) ), family = "Arial", size = 12 / .pt ) +
  scale_fill_manual( values = c( "#C77CFF", "#00BFC4", "#7CAE00", "#F8766D" ),
                     breaks = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ),
                     na.value = NA ) +
  scale_x_discrete( limits = c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021" ), labels = c( "2010", "2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.91 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
         ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = factor( sexual_identity_2010, levels = c( "Other", "Bisexual", "Homosexual", "Heterosexual" ) ),
                        label = ifelse( year == "sexual_identity_2021" & ( percent_for_label >= 0.1 | number >= 15 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.25,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
                   )


# >=60
ggplot( m123_age_60_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  geom_alluvium( aes( fill = sexual_identity_2010 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010 ) ) +
  geom_text( stat = "stratum", aes( label = after_stat( stratum ) ), family = "Arial", size = 12 / .pt ) +
  scale_fill_manual( values = c( "#C77CFF", "#00BFC4", "#7CAE00", "#F8766D" ),
                     breaks = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ),
                     na.value = NA ) +
  scale_x_discrete( limits = c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021" ), labels = c( "2010", "2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.88 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
         ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = factor( sexual_identity_2010, levels = c( "Other", "Bisexual", "Homosexual", "Heterosexual" ) ),
                        label = ifelse( year == "sexual_identity_2021" & ( percent_for_label >= 0.1 | number >= 20 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.25,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
                   )
```

### 4. Estimation of Proportion of Changes in Sexual Identity
#### 4.1. Prepare dataset
```{r}
d_prop_fluidity <- d_fluidity_model

d_prop_fluidity$age_sex <- interaction( d_prop_fluidity$age_exp, d_prop_fluidity$sex_exp )

d_prop_fluidity$sexual_identity_fluidity <- factor(
  ifelse( d_prop_fluidity$sexual_identity_fluidity == 1, "changed", "unchanged" ),
  levels = c( "changed", "unchanged" )
)

d_prop_fluidity$living_status_exp <- as.factor(
  ifelse( d_prop_fluidity$living_status_exp == "yes", 
          "living_alone_yes",
          "living_alone_no" )
)

d_prop_fluidity$personal_support_exp <- as.factor(
  ifelse( d_prop_fluidity$personal_support_exp == "yes", 
          "personal_support_yes",
          "personal_support_no" ) 
)
```

#### 4.2. Caculate proportions
```{r}
# among different demographic subgroups
demographic_variables <- c( "sexual_identity_2010_exp", "sex_exp", "age_exp", "age_sex", "country_of_birth_exp", "education_exp", "income_exp", "marital_status_exp", "living_status_exp", "personal_support_exp", "year_exp" )

results_list <- list()

for ( variable in demographic_variables ) {
  results_list[[ variable ]] <- d_prop_fluidity %>%
    filter( !is.na( .[[ variable ]] ) )  %>%
    group_by( !!sym( variable ) ) %>%
    summarize( count = n(),
               fluid_count = sum( sexual_identity_fluidity == "changed" ),
               proportion = fluid_count / count ) %>%
    rename( subgroup = !!sym( variable ) )
}

combined_results <- bind_rows( results_list )

overall_df <- data.frame(
  subgroup = "Stockholm County",
  count = nrow( d_prop_fluidity ),
  fluid_count = nrow( d_prop_fluidity[ d_prop_fluidity$sexual_identity_fluidity == "changed",  ] ),
  proportion = nrow( d_prop_fluidity[ d_prop_fluidity$sexual_identity_fluidity == "changed",  ] ) / nrow( d_prop_fluidity )
)

final_results <- bind_rows( combined_results, overall_df )

# calculate Clopper-Pearson 95% confidence interval
final_results$changed_lower_ci <- mapply( function( x, n ) binom.test( x, n )$conf.int[1],
                                          final_results$fluid_count, 
                                          final_results$count )

final_results$changed_upper_ci <- mapply( function( x, n ) binom.test( x, n )$conf.int[2],
                                          final_results$fluid_count, 
                                          final_results$count )

writexl::write_xlsx( final_results, "fluidity_cc_prop_summary_SPHC-F_2010-2021.xlsx" )
```

### 5. Relation between Changes in Sexual Identity and Demographic Factors
#### 5.1. Complete-case analysis
##### 5.1.1. Define model formula
```{r}
##### exposure of interest: cohort year #####

fml_year_crude <- sexual_identity_fluidity ~ year_exp
fml_year_model_1 <- sexual_identity_fluidity ~ year_exp + age_conf + sex_conf + country_of_birth_conf
fml_year_model_2 <- sexual_identity_fluidity ~ year_exp + age_conf + sex_conf + country_of_birth_conf + education_conf + income_conf + marital_status_conf + living_status_conf + personal_support_conf + place_of_residence_conf + sexual_identity_2010_conf

# list of formulas
fml_list_year <- list(
  fml_year_crude = fml_year_crude,
  fml_year_model_1 = fml_year_model_1,
  fml_year_model_2 = fml_year_model_2
  )


##### exposure of interest: sexual identity in 2010 #####

fml_sexual_identity_crude <- sexual_identity_fluidity ~ sexual_identity_2010_exp
fml_sexual_identity_model_1 <- sexual_identity_fluidity ~ sexual_identity_2010_exp + age_conf + sex_conf + country_of_birth_conf + year_conf
fml_sexual_identity_model_2 <- sexual_identity_fluidity ~ sexual_identity_2010_exp + age_conf + sex_conf + country_of_birth_conf + education_conf + income_conf + marital_status_conf + living_status_conf + personal_support_conf + place_of_residence_conf + year_conf

# list of formulas
fml_list_sexual_identity <- list(
  fml_sexual_identity_crude = fml_sexual_identity_crude,
  fml_sexual_identity_model_1 = fml_sexual_identity_model_1,
  fml_sexual_identity_model_2 = fml_sexual_identity_model_2
)


##### exposure of interest: age #####

fml_age_crude <- sexual_identity_fluidity ~ age_exp
fml_age_model_1 <- sexual_identity_fluidity ~ age_exp + sex_conf + country_of_birth_conf + year_conf
fml_age_model_2 <- sexual_identity_fluidity ~ age_exp + sex_conf + country_of_birth_conf + education_conf + income_conf + marital_status_conf + living_status_conf + personal_support_conf + place_of_residence_conf + year_conf + sexual_identity_2010_conf

# list of formulas
fml_list_age <- list(
  fml_age_crude = fml_age_crude,
  fml_age_model_1 = fml_age_model_1,
  fml_age_model_2 = fml_age_model_2
  )


##### exposure of interest: age by sex #####

fml_age_by_sex_crude <- sexual_identity_fluidity ~ age_exp*sex_exp
fml_age_by_sex_model_1 <- sexual_identity_fluidity ~ age_exp*sex_exp + country_of_birth_conf + year_conf
fml_age_by_sex_model_2 <- sexual_identity_fluidity ~ age_exp*sex_exp + country_of_birth_conf + education_conf + income_conf + marital_status_conf + living_status_conf + personal_support_conf + place_of_residence_conf + year_conf + sexual_identity_2010_conf

# list of formulas
fml_list_age_by_sex <- list(
  fml_age_by_sex_crude = fml_age_by_sex_crude,
  fml_age_by_sex_model_1 = fml_age_by_sex_model_1,
  fml_age_by_sex_model_2 = fml_age_by_sex_model_2
  )


##### exposure of interest: sex #####

fml_sex_crude <- sexual_identity_fluidity ~ sex_exp
fml_sex_model_1 <- sexual_identity_fluidity ~ sex_exp + age_conf + country_of_birth_conf + year_conf
fml_sex_model_2 <- sexual_identity_fluidity ~ sex_exp + age_conf + country_of_birth_conf + education_conf + income_conf + marital_status_conf + living_status_conf + personal_support_conf + place_of_residence_conf + year_conf + sexual_identity_2010_conf

# list of formulas
fml_list_sex <- list(
  fml_sex_crude = fml_sex_crude,
  fml_sex_model_1 = fml_sex_model_1,
  fml_sex_model_2 = fml_sex_model_2
  )


##### exposure of interest: country of birth #####

fml_country_of_birth_crude <- sexual_identity_fluidity ~ country_of_birth_exp
fml_country_of_birth_model_1 <- sexual_identity_fluidity ~ country_of_birth_exp + age_conf + sex_conf + year_conf
fml_country_of_birth_model_2 <- sexual_identity_fluidity ~ country_of_birth_exp + age_conf + sex_conf + education_conf + income_conf + marital_status_conf + living_status_conf + personal_support_conf + place_of_residence_conf + year_conf + sexual_identity_2010_conf

# list of formulas
fml_list_country_of_birth <- list(
  fml_country_of_birth_crude = fml_country_of_birth_crude,
  fml_country_of_birth_model_1 = fml_country_of_birth_model_1,
  fml_country_of_birth_model_2 = fml_country_of_birth_model_2
  )


##### exposure of interest: education #####

fml_education_crude <- sexual_identity_fluidity ~ education_exp
fml_education_model_1 <- sexual_identity_fluidity ~ education_exp + age_conf + sex_conf + country_of_birth_conf + year_conf
fml_education_model_2 <- sexual_identity_fluidity ~ education_exp + age_conf + sex_conf + country_of_birth_conf + income_conf + marital_status_conf + living_status_conf + personal_support_conf + place_of_residence_conf + year_conf + sexual_identity_2010_conf

# list of formulas
fml_list_education <- list(
  fml_education_crude = fml_education_crude,
  fml_education_model_1 = fml_education_model_1,
  fml_education_model_2 = fml_education_model_2
  )


##### exposure of interest: income #####

fml_income_crude <- sexual_identity_fluidity ~ income_exp
fml_income_model_1 <- sexual_identity_fluidity ~ income_exp + age_conf + sex_conf + country_of_birth_conf + year_conf
fml_income_model_2 <- sexual_identity_fluidity ~ income_exp + age_conf + sex_conf + country_of_birth_conf + education_conf + marital_status_conf + living_status_conf + personal_support_conf + place_of_residence_conf + year_conf + sexual_identity_2010_conf

# list of formulas
fml_list_income <- list(
  fml_income_crude = fml_income_crude,
  fml_income_model_1 = fml_income_model_1,
  fml_income_model_2 = fml_income_model_2
  )


##### exposure of interest: marital status #####

fml_marital_status_crude <- sexual_identity_fluidity ~ marital_status_exp
fml_marital_status_model_1 <- sexual_identity_fluidity ~ marital_status_exp + age_conf + sex_conf + country_of_birth_conf + year_conf
fml_marital_status_model_2 <- sexual_identity_fluidity ~ marital_status_exp + age_conf + sex_conf + country_of_birth_conf + education_conf + income_conf + living_status_conf + personal_support_conf + place_of_residence_conf + year_conf + sexual_identity_2010_conf

# list of formulas
fml_list_marital_status <- list(
  fml_marital_status_crude = fml_marital_status_crude,
  fml_marital_status_model_1 = fml_marital_status_model_1,
  fml_marital_status_model_2 = fml_marital_status_model_2
  )


##### exposure of interest: living status #####

fml_living_status_crude <- sexual_identity_fluidity ~ living_status_exp
fml_living_status_model_1 <- sexual_identity_fluidity ~ living_status_exp + age_conf + sex_conf + country_of_birth_conf + year_conf
fml_living_status_model_2 <- sexual_identity_fluidity ~ living_status_exp + age_conf + sex_conf + country_of_birth_conf + education_conf + income_conf + marital_status_conf + personal_support_conf + place_of_residence_conf + year_conf + sexual_identity_2010_conf

# list of formulas
fml_list_living_status <- list(
  fml_living_status_crude = fml_living_status_crude,
  fml_living_status_model_1 = fml_living_status_model_1,
  fml_living_status_model_2 = fml_living_status_model_2
  )


##### exposure of interest: personal support #####

fml_personal_support_crude <- sexual_identity_fluidity ~ personal_support_exp
fml_personal_support_model_1 <- sexual_identity_fluidity ~ personal_support_exp + age_conf + sex_conf + country_of_birth_conf + year_conf
fml_personal_support_model_2 <- sexual_identity_fluidity ~ personal_support_exp + age_conf + sex_conf + country_of_birth_conf + education_conf + income_conf + marital_status_conf + living_status_conf + place_of_residence_conf + year_conf + sexual_identity_2010_conf

# list of formulas
fml_list_personal_support <- list(
  fml_personal_support_crude = fml_personal_support_crude,
  fml_personal_support_model_1 = fml_personal_support_model_1,
  fml_personal_support_model_2 = fml_personal_support_model_2
  )

exposures <- c( "year", "sexual_identity", "age", "age_by_sex", "sex", "country_of_birth", "education", "income", "marital_status", "living_status", "personal_support" )
```

##### 5.1.2. Crude and adjusted analyses
```{r}
# fit Poisson regression model for each exposure
models_fluidity_cc <- list()

for ( exposure in exposures ) {
  models_fluidity_cc[[ exposure ]] <- list()
  
  fml_list_name <- paste( "fml_list", exposure, sep = "_" )
  
  for ( name in names( get( fml_list_name ) ) ) {
    models_fluidity_cc[[ exposure ]][[ name ]] <- glm( get( fml_list_name )[[ name ]], 
                                                       family = quasipoisson( link = "log" ), 
                                                       data = d_fluidity_model ) 
    }
  }

# refit the model for age by sex, using female as the reference group
# to extract results for age among females
d_fluidity_model$sex_exp <- relevel( d_fluidity_model$sex_exp, ref = "Female" )

refit_model_fluidity_cc_age_by_sex <- list()

for ( name in names( fml_list_age_by_sex ) ) {
  refit_model_fluidity_cc_age_by_sex[[ name ]] <- glm( fml_list_age_by_sex[[ name ]], 
                                                       family = quasipoisson( link = "log" ), 
                                                       data = d_fluidity_model )
  }
```

##### 5.1.3. Extract results
```{r}
##### exposure of interest: cohort year #####

exposures_year <- c( "year_expSPHC 2006", "year_expSPHC 2010"  )

# extract coefficient and 95% CI
fluidity_cc_year_coef <- list()

for ( name in names( fml_list_year ) ) {
  
    fluidity_cc_year_coef[[ name ]] <- extract_results_coef_fluidity(
      all_models_list = models_fluidity_cc, 
      exposure = "year", 
      model_type = name, 
      variables = exposures_year
    )
}

# extract risk ratio and 95% CI
fluidity_cc_year_rr <- extract_rr_fluidity( fluidity_cc_year_coef )


##### exposure of interest: sexual identity in 2010 #####

exposures_sexual_identity <- c( "sexual_identity_2010_expHomosexual", "sexual_identity_2010_expBisexual", "sexual_identity_2010_expOther"  )

# extract coefficient and 95% CI
fluidity_cc_sexual_identity_coef <- list()

for ( name in names( fml_list_sexual_identity ) ) {
  
    fluidity_cc_sexual_identity_coef[[ name ]] <- extract_results_coef_fluidity(
      all_models_list = models_fluidity_cc, 
      exposure = "sexual_identity", 
      model_type = name, 
      variables = exposures_sexual_identity
    )
}

# extract risk ratio and 95% CI
fluidity_cc_sexual_identity_rr <- extract_rr_fluidity( fluidity_cc_sexual_identity_coef )


##### exposure of interest: age #####

exposures_age <- c( "age_exp<=29", "age_exp30-44", "age_exp>=60"  )

# extract coefficient and 95% CI
fluidity_cc_age_coef <- list()

for ( name in names( fml_list_age ) ) {
  
  fluidity_cc_age_coef[[ name ]] <- extract_results_coef_fluidity(
    all_models_list = models_fluidity_cc, 
    exposure = "age", 
    model_type = name, 
    variables = exposures_age
  )
}

# extract risk ratio and 95% CI
fluidity_cc_age_rr <- extract_rr_fluidity( fluidity_cc_age_coef )


##### exposure of interest: age by sex #####

exposures_age_male <- c( "age_exp<=29", "age_exp30-44", "age_exp>=60", "age_exp<=29:sex_expFemale", "age_exp30-44:sex_expFemale", "age_exp>=60:sex_expFemale" )

# extract coefficient and 95% CI among males
fluidity_cc_age_by_sex_coef_male <- list()

for ( name in names( fml_list_age_by_sex ) ) {
  
  fluidity_cc_age_by_sex_coef_male[[ name ]] <- extract_results_coef_fluidity(
    all_models_list = models_fluidity_cc, 
    exposure = "age_by_sex", 
    model_type = name, 
    variables = exposures_age_male
  )
}

# extract risk ratio and 95% CI among males
fluidity_cc_age_by_sex_rr_male <- extract_rr_fluidity( fluidity_cc_age_by_sex_coef_male ) %>%
  mutate( Exposure = ifelse( grepl( "age_exp", Exposure ) & !grepl( "Female", Exposure ), 
                               paste0( Exposure, "_Male" ), Exposure ) )


exposures_age_female <- c( "age_exp<=29", "age_exp30-44", "age_exp>=60", "age_exp<=29:sex_expMale", "age_exp30-44:sex_expMale", "age_exp>=60:sex_expMale" )

# extract coefficient and 95% CI among females
fluidity_cc_age_by_sex_coef_female <- list()

for( model_name in names( refit_model_fluidity_cc_age_by_sex ) ) {
  
  model <- refit_model_fluidity_cc_age_by_sex[[ model_name ]]
  
  results <- cbind( coef( model )[ exposures_age_female ], 
                    coefci( model, vcov = sandwich )[ exposures_age_female, , drop = FALSE ] )
  
  fluidity_cc_age_by_sex_coef_female[[ model_name ]] <- results
}

# extract risk ratio and 95% CI among females
fluidity_cc_age_by_sex_rr_female <- extract_rr_fluidity( fluidity_cc_age_by_sex_coef_female ) %>%
  mutate( Exposure = ifelse( grepl( "age_exp", Exposure ) & !grepl( "Male", Exposure ), 
                             paste0( Exposure, "_Female" ), Exposure ) )

fluidity_cc_age_by_sex_rr <- rbind( fluidity_cc_age_by_sex_rr_male[ c( 1:3 ), ], 
                                    fluidity_cc_age_by_sex_rr_female[ c( 1:3 ), ] )


##### exposure of interest: sex #####

exposures_sex <- c( "sex_expFemale" )

# extract coefficient and 95% CI
fluidity_cc_sex_coef <- list()

for ( name in names( fml_list_sex ) ) {
  
  fluidity_cc_sex_coef[[ name ]] <- extract_results_coef_fluidity(
    all_models_list = models_fluidity_cc, 
    exposure = "sex", 
    model_type = name, 
    variables = exposures_sex
  )
}

# extract risk ratio and 95% CI
fluidity_cc_sex_rr <- extract_rr_fluidity( fluidity_cc_sex_coef )


##### exposure of interest: country of birth #####

exposures_country_of_birth <- c( "country_of_birth_expEurope", "country_of_birth_expOutside Europe" )

# extract coefficient and 95% CI
fluidity_cc_country_of_birth_coef <- list()

for ( name in names( fml_list_country_of_birth ) ) {
  
  fluidity_cc_country_of_birth_coef[[ name ]] <- extract_results_coef_fluidity(
    all_models_list = models_fluidity_cc, 
    exposure = "country_of_birth", 
    model_type = name, 
    variables = exposures_country_of_birth
  )
}

# extract risk ratio and 95% CI
fluidity_cc_country_of_birth_rr <- extract_rr_fluidity( fluidity_cc_country_of_birth_coef )


##### exposure of interest: education #####

exposures_education <- c( "education_exp<=9 years", "education_exp10-12 years" )

# extract coefficient and 95% CI
fluidity_cc_education_coef <- list()

for ( name in names( fml_list_education ) ) {
  
  fluidity_cc_education_coef[[ name ]] <- extract_results_coef_fluidity(
    all_models_list = models_fluidity_cc, 
    exposure = "education", 
    model_type = name, 
    variables = exposures_education
  )
}

# extract risk ratio and 95% CI
fluidity_cc_education_rr <- extract_rr_fluidity( fluidity_cc_education_coef )


##### exposure of interest: income #####

exposures_income <- c( "income_exp<=2,500", "income_exp(2,500, 3,500]", "income_exp(3,500, 4,500]" )

# extract coefficient and 95% CI
fluidity_cc_income_coef <- list()

for ( name in names( fml_list_income ) ) {
  
  fluidity_cc_income_coef[[ name ]] <- extract_results_coef_fluidity(
    all_models_list = models_fluidity_cc, 
    exposure = "income", 
    model_type = name, 
    variables = exposures_income
  )
}

# extract risk ratio and 95% CI
fluidity_cc_income_rr <- extract_rr_fluidity( fluidity_cc_income_coef )


##### exposure of interest: marital status #####

exposures_marital_status <- c( "marital_status_expNever married", "marital_status_expOther" )

# extract coefficient and 95% CI
fluidity_cc_marital_status_coef <- list()

for ( name in names( fml_list_marital_status ) ) {
  
  fluidity_cc_marital_status_coef[[ name ]] <- extract_results_coef_fluidity(
    all_models_list = models_fluidity_cc, 
    exposure = "marital_status", 
    model_type = name, 
    variables = exposures_marital_status
  )
}

# extract risk ratio and 95% CI
fluidity_cc_marital_status_rr <- extract_rr_fluidity( fluidity_cc_marital_status_coef )


##### exposure of interest: living status #####

exposures_living_status <- c( "living_status_expyes" )

# extract coefficient and 95% CI
fluidity_cc_living_status_coef <- list()

for ( name in names( fml_list_living_status ) ) {
  
  fluidity_cc_living_status_coef[[ name ]] <- extract_results_coef_fluidity(
    all_models_list = models_fluidity_cc, 
    exposure = "living_status", 
    model_type = name, 
    variables = exposures_living_status
  )
}

# extract risk ratio and 95% CI
fluidity_cc_living_status_rr <- extract_rr_fluidity( fluidity_cc_living_status_coef )


##### exposure of interest: personal support #####

exposures_personal_support <- c( "personal_support_expno" )

# extract coefficient and 95% CI
fluidity_cc_personal_support_coef <- list()

for ( name in names( fml_list_personal_support ) ) {
  
  fluidity_cc_personal_support_coef[[ name ]] <- extract_results_coef_fluidity(
    all_models_list = models_fluidity_cc, 
    exposure = "personal_support", 
    model_type = name, 
    variables = exposures_personal_support
  )
}

# extract risk ratio and 95% CI
fluidity_cc_personal_support_rr <- extract_rr_fluidity( fluidity_cc_personal_support_coef )


##### combine results #####

fluidity_cc_rr <- rbind( fluidity_cc_year_rr,
                         fluidity_cc_sexual_identity_rr,
                         fluidity_cc_age_rr,
                         fluidity_cc_age_by_sex_rr,
                         fluidity_cc_sex_rr,
                         fluidity_cc_country_of_birth_rr,
                         fluidity_cc_education_rr,
                         fluidity_cc_income_rr,
                         fluidity_cc_marital_status_rr,
                         fluidity_cc_living_status_rr,
                         fluidity_cc_personal_support_rr
                         )

writexl::write_xlsx( fluidity_cc_rr, "fluidity_cc_rr_SPHC-F_2010-2021.xlsx" )
```
