---
title: "Fluidity of self-reported sexual identity in Stockholm County from 2010 to 2021"
author: Guoqiang Zhang (guoqiang.zhang@ki.se)
output: html_notebook
editor_options: 
  chunk_output_type: console
---

Notes: 'SPHC-B + year' refers to the baseline survey in the Stockholm Public Health Cohort (SPHC), and 'SPHC-F + year' refers to the follow-up survey. For example, SPHC-B 2010 represents the baseline survey in 2010, and SPHC-F 2014 represents the follow-up survey in 2014.

This R Notebook presents the analyses among individuals who provided data on sexual identity in the follow-up surveys (SPHC-F 2010, 2014, and 2021) following their participation in the baseline surveys (SPHC-B 2002, 2006, and 2010). The analyses include:
- Visual representation of changes in sexual identity over time
- Relationship between changes in sexual identity and demographic factors

The analyses examining the relationship between changes in sexual identity and demographic factors in SPHC-B 2010 and 2014 are available, respectively, in the R Notebooks "SPHC-B_2010" and "SPHC-B_2014".

### 1. Load Packages
```{r}
library(haven)
library(naniar)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(ggalluvial)
library(ggbreak)
library(ggrepel)
library(grDevices)
```

### 2. The Stockholm Public Health Cohort
#### 2.1. SPHC-B 2002 with SPHC-F 2010-2021
```{r}
d_2002 <- read_sas("/Volumes/LGBT Project data/sphc02_07_10_14_21.sas7bdat")

# sexual identity in 2010
table( d_2002$F10F103, useNA = "always" )
d_2002$F10F103[ d_2002$F10F103 == 9 ] <- NA
d_2002$sexual_identity_2010 <- factor( ifelse( d_2002$F10F103 == 1, "Heterosexual",
                                                  ifelse( d_2002$F10F103 == 2, "Homosexual",
                                                          ifelse( d_2002$F10F103 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2002$sexual_identity_2010, useNA = "always" )

# sexual identity in 2014
table( d_2002$F14F103, useNA = "always" )
d_2002$sexual_identity_2014 <- factor( ifelse( d_2002$F14F103 == 1, "Heterosexual",
                                                  ifelse( d_2002$F14F103 == 2, "Homosexual",
                                                          ifelse( d_2002$F14F103 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2002$sexual_identity_2014, useNA = "always" )

# sexual identity in 2021
table( d_2002$F21F91, useNA = "always" )
d_2002$sexual_identity_2021 <- factor( ifelse( d_2002$F21F91 == 1, "Heterosexual",
                                                  ifelse( d_2002$F21F91 == 2, "Homosexual",
                                                          ifelse( d_2002$F21F91 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2002$sexual_identity_2021, useNA = "always" )

# sex
table( d_2002$kon, useNA = "always" )
d_2002$sex <- factor( ifelse( d_2002$kon == 1, "Male", "Female" ),
                      levels = c( "Male", "Female" ) )
table( d_2002$sex, useNA = "always" )

# age
summary( d_2002$F2alder )
d_2002$age_2002 <- d_2002$F2alder
d_2002$age_2010 <- d_2002$age_2002 + 8
d_2002$age_2010_cat <- factor( ifelse( d_2002$age_2010 <= 29, "16-29", 
                                       ifelse( d_2002$age_2010 >=30 & d_2002$age_2010 <= 44, "30-44",
                                               ifelse( d_2002$age_2010 >= 45 & d_2002$age_2010 <= 59, "45-59", ">=60" ) ) ),
                               levels = c( "16-29", "30-44", "45-59", ">=60" ) )
table( d_2002$age_2010_cat, useNA = "always" )
```

#### 2.2. SPHC-B 2006 with SPHC-F 2010-2021
```{r}
d_2006 <- read_sas("/Volumes/LGBT Project data/sphc06_10_14_21.sas7bdat")

# sexual identity in 2010
table( d_2006$F10F103, useNA = "always" )
d_2006$F10F103[ d_2006$F10F103 == 9 ] <- NA
d_2006$sexual_identity_2010 <- factor( ifelse( d_2006$F10F103 == 1, "Heterosexual",
                                                  ifelse( d_2006$F10F103 == 2, "Homosexual",
                                                          ifelse( d_2006$F10F103 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2006$sexual_identity_2010, useNA = "always" )

# sexual identity in 2014
table( d_2006$F14F103, useNA = "always" )
d_2006$sexual_identity_2014 <- factor( ifelse( d_2006$F14F103 == 1, "Heterosexual",
                                                  ifelse( d_2006$F14F103 == 2, "Homosexual",
                                                          ifelse( d_2006$F14F103 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2006$sexual_identity_2014, useNA = "always" )

# sexual identity in 2021
table( d_2006$F21F91, useNA = "always" )
d_2006$sexual_identity_2021 <- factor( ifelse( d_2006$F21F91 == 1, "Heterosexual",
                                                  ifelse( d_2006$F21F91 == 2, "Homosexual",
                                                          ifelse( d_2006$F21F91 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2006$sexual_identity_2021, useNA = "always" )

# sex
table( d_2006$kon, useNA = "always" )
d_2006$sex <- factor( ifelse( d_2006$kon == 1, "Male", "Female" ),
                      levels = c( "Male", "Female" ) )
table( d_2006$sex, useNA = "always" )

# age
summary( d_2006$F6alder )
d_2006$age_2006 <- d_2006$F6alder
d_2006$age_2010 <- d_2006$age_2006 + 4
d_2006$age_2010_cat <- factor( ifelse( d_2006$age_2010 <= 29, "16-29", 
                                       ifelse( d_2006$age_2010 >=30 & d_2006$age_2010 <= 44, "30-44",
                                               ifelse( d_2006$age_2010 >= 45 & d_2006$age_2010 <= 59, "45-59", ">=60" ) ) ),
                               levels = c( "16-29", "30-44", "45-59", ">=60" ) )
table( d_2006$age_2010_cat, useNA = "always" )

# sampling strata
n_miss( d_2006$stratum )
d_2006$sampling_strata <- as.factor( d_2006$stratum )
length( unique( d_2006$sampling_strata ) ) # 43 strata


##### design weights #####

summary( d_2006$F6dvikt )
d_2006$design_weight <- d_2006$F6dvikt


##### non-response #####

# unit non-response
d_2006$design_weight_unit_nonresponse <- d_2006$F6dbvikt # weights calculated assuming Missing Completely At Random (MCAR) within each stratum
summary( d_2006$design_weight_unit_nonresponse )
sum( d_2006$design_weight_unit_nonresponse ) # No. of source population = 1,450,501

unitresponse_prob <- d_2006 %>% 
  group_by( sampling_strata ) %>% 
  summarise( unitresponse_prob = unique( design_weight ) / unique( design_weight_unit_nonresponse ),
             no.of.population = sum( design_weight_unit_nonresponse ),
             sample_size = unique( no.of.population )/unique( design_weight ) ) # calculate overall unit response rate, and no. of population and sample size within each stratum
d_2006 <- d_2006 %>% 
  left_join( unitresponse_prob, by = "sampling_strata" )

# item non-response
itemresponse_prob <- d_2006 %>% 
  group_by( sampling_strata ) %>% 
  summarise( itemresponse_prob = sum( !is.na( sexual_identity_2010 ) ) / n() ) # calculate item response rate

d_2006 <- d_2006 %>% 
  left_join( itemresponse_prob, by = "sampling_strata" ) %>% 
  mutate( itemresponse_prob = ifelse( is.na( sexual_identity_2010 ), 0, itemresponse_prob ) )


##### summary of stratified sampling #####

sampling_frame_2006 <- as.data.frame( d_2006 %>% 
                                        group_by( sampling_strata ) %>% 
                                        reframe( no.of.population = unique( no.of.population ), 
                                                 sample_size = unique( no.of.population/design_weight ),
                                                 unitresponse = n(),
                                                 itemresponse = sum( itemresponse_prob != 0 ) ) )

sampling_frame_2006$unitresponse_rate <- sampling_frame_2006$unitresponse/sampling_frame_2006$sample_size
sampling_frame_2006$itemresponse_rate <- sampling_frame_2006$itemresponse/sampling_frame_2006$unitresponse
sampling_frame_2006$overallresponse_rate <- sampling_frame_2006$itemresponse/sampling_frame_2006$sample_size

sampling_frame_2006$unitresponse_label <- paste0( sampling_frame_2006$unitresponse, " (", 
                                                  sprintf( "%.1f", sampling_frame_2006$unitresponse_rate*100 ), "%)" )
sampling_frame_2006$overallresponse_label <- paste0( sampling_frame_2006$itemresponse, " (", 
                                                     sprintf( "%.1f", sampling_frame_2006$overallresponse_rate*100 ), "%)" )

round( sum( sampling_frame_2006$unitresponse )/( sum( sampling_frame_2006$sample_size ) ), 3 ) # overall unit response rate
round( sum( sampling_frame_2006$itemresponse )/( sum( sampling_frame_2006$unitresponse ) ), 3 ) # overall item response rate
round( sum( sampling_frame_2006$itemresponse )/( sum( sampling_frame_2006$sample_size ) ), 3 ) # overall response rate

writexl::write_xlsx( sampling_frame_2006, "sampling_frame_2006.xlsx" )
```

#### 2.3. SPHC-B 2010 with SPHC-F 2014-2021
```{r}
load("/Volumes/LGBT Project data/d_2010.RData")

# sexual identity in 2010
table( d_2010$F10U87G78, useNA = "always" )
d_2010$F10U87G78[ d_2010$F10U87G78 == 9 ] <- NA
d_2010$sexual_identity_2010 <- factor( ifelse( d_2010$F10U87G78 == 1, "Heterosexual",
                                                  ifelse( d_2010$F10U87G78 == 2, "Homosexual",
                                                          ifelse( d_2010$F10U87G78 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2010$sexual_identity_2010, useNA = "always" )

# sexual identity in 2014
table( d_2010$F14F103, useNA = "always" )
d_2010$sexual_identity_2014 <- factor( ifelse( d_2010$F14F103 == 1, "Heterosexual",
                                                  ifelse( d_2010$F14F103 == 2, "Homosexual",
                                                          ifelse( d_2010$F14F103 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2010$sexual_identity_2014, useNA = "always" )

# sexual identity in 2021
table( d_2010$F21F91, useNA = "always" )
d_2010$sexual_identity_2021 <- factor( ifelse( d_2010$F21F91 == 1, "Heterosexual",
                                                  ifelse( d_2010$F21F91 == 2, "Homosexual",
                                                          ifelse( d_2010$F21F91 == 3, "Bisexual", "Other" ) ) ),
                                          levels = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ) )
table( d_2010$sexual_identity_2021, useNA = "always" )

# sex
table( d_2010$kon, useNA = "always" )
d_2010$sex <- factor( ifelse( d_2010$kon == 1, "Male", "Female" ),
                      levels = c( "Male", "Female" ) )
table( d_2010$sex, useNA = "always" )

# age
summary( d_2010$F10alder )
d_2010$age_2010 <- d_2010$F10alder
d_2010$age_2010_cat <- factor( ifelse( d_2010$age_2010 <= 29, "16-29", 
                                       ifelse( d_2010$age_2010 >=30 & d_2010$age_2010 <= 44, "30-44",
                                               ifelse( d_2010$age_2010 >= 45 & d_2010$age_2010 <= 59, "45-59", ">=60" ) ) ),
                               levels = c( "16-29", "30-44", "45-59", ">=60" ) )
table( d_2010$age_2010_cat, useNA = "always" )

# country of birth
table( d_2010$fodelseland, useNA = "always" )
d_2010$country_of_birth <- factor( ifelse( d_2010$fodelseland == "Afrika", "Africa",
                                           ifelse( d_2010$fodelseland == "Asien", "Asia",
                                                   ifelse( d_2010$fodelseland == "Europa", "Europe",
                                                           ifelse( d_2010$fodelseland == "Sverige", "Sweden", "Americas" ) ) ) ),
                                   levels = c( "Africa", "Americas", "Asia", "Europe", "Sweden" ) )
table( d_2010$country_of_birth, useNA = "always" )

# education
table( d_2010$utbniva2010, useNA = "always" )
d_2010$education <- factor( ifelse( d_2010$utbniva2010 <= 2, "<=9 years",
                                    ifelse( d_2010$utbniva2010 <= 4, "10-12 years", ">=13 years" ) ), 
                            levels = c( "<=9 years", "10-12 years", ">=13 years" ) )
table( d_2010$education, useNA = "always" )

# disposable income
summary( d_2010$dispink2010, useNA = "always" )
d_2010$income <- factor( ifelse( d_2010$dispink2010 <= 2500, "<=2,500",
                                 ifelse( d_2010$dispink2010 > 2500 & d_2010$dispink2010 <= 3500, "(2,500, 3,500]",
                                         ifelse( d_2010$dispink2010 > 3500 & d_2010$dispink2010 <= 4500, "(3,500, 4,500]", ">4,500" ) ) ),
                         levels = c( "<=2,500", "(2,500, 3,500]", "(3,500, 4,500]", ">4,500" ) )
table( d_2010$income, useNA = "always" )

# marital status
table( d_2010$civil2010, useNA = "always" )
d_2010$marital_status <- factor( ifelse( d_2010$civil2010 == "G" | d_2010$civil2010 == "RP", "Currently married",
                                         ifelse( d_2010$civil2010 == "OG", "Never married", "Other" ) ), 
                                 levels = c( "Never married", "Currently married", "Other" ) )
table( d_2010$marital_status, useNA = "always" )

# living alone
table( d_2010$F10U53aG57a, useNA = "always" )
d_2010$F10U53aG57a[ d_2010$F10U53aG57a == 9 ] <- NA
d_2010$living_alone <- factor( ifelse( d_2010$F10U53aG57a == 1, "no", "yes" ), 
                               levels = c( "yes", "no" ) )
table( d_2010$living_alone, useNA = "always" )

# personal support
table( d_2010$F10U57G62, useNA = "always" )
d_2010$F10U57G62[ d_2010$F10U57G62 == 9 ] <- NA
d_2010$personal_support <- factor( ifelse( d_2010$F10U57G62 <= 2, "yes", "no" ), 
                                   levels = c( "yes", "no" ) )
table( d_2010$personal_support, useNA = "always" )

# sampling strata
n_miss( d_2010$stratum )
d_2010$sampling_strata <- as.factor( d_2010$stratum )
length( unique( d_2010$sampling_strata ) ) # 39 strata
```

#### 2.4. Merge data across surveys
```{r}
m1 <- d_2002[ !is.na( d_2002$sexual_identity_2010 ) & 
                !is.na( d_2002$sexual_identity_2014 ) & 
                !is.na( d_2002$sexual_identity_2021 ), 
              c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021", "sex", "age_2010" ) ]
m1$year <- rep( "SPHC 2002", nrow( m1 ) )

m2 <- d_2006[ !is.na( d_2006$sexual_identity_2010 ) & 
                !is.na( d_2006$sexual_identity_2014 ) & 
                !is.na( d_2006$sexual_identity_2021 ), 
              c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021", "sex", "age_2010" ) ]
m2$year <- rep( "SPHC 2006", nrow( m2 ) )

m3 <- d_2010[ !is.na( d_2010$sexual_identity_2010 ) & 
                !is.na( d_2010$sexual_identity_2014 ) & 
                !is.na( d_2010$sexual_identity_2021 ),
              c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021", "sex", "age_2010" ) ]
m3$year <- rep( "SPHC 2010", nrow( m3 ) )

m123 <- reduce( list( m1, m2, m3 ), 
                full_join, 
                by = c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021", "sex", "age_2010", "year" ) )
```

### 3. Make Fluidity Plots
#### 3.1. Prepare dataset for plotting
##### 3.1.1. Among all participants
```{r}
# changes of sexual identity from 2010 to 2021
m123_all <- m123 %>%
  count( sexual_identity_2010, sexual_identity_2014, sexual_identity_2021, name = "number" ) %>%
  mutate( percent = number / sum( number ) )

m123_all <- m123_all %>%
  group_by( sexual_identity_2010 ) %>%
  mutate( percent_for_label = number / sum( number ) ) %>%
  ungroup()

m123_all$label <- paste0( prettyNum( m123_all$number, big.mark = "," , preserve.width = "none" ), 
                          " (", sprintf( "%.1f", m123_all$percent_for_label*100 ), "%)" 
                          )

for ( col in 1:3 ) {
  m123_all[[col]] <- factor( m123_all[[col]], levels = c( "Homosexual", "Bisexual", "Other", "Heterosexual" ) ) 
}

m123_all_long <- to_lodes_form( m123_all, axes = 1:3, key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010 ) # convert to long format


# changes of sexual identity from 2010-2014 to 2021
x123_all <- m123 %>%
  count( sexual_identity_2010, sexual_identity_2014, sexual_identity_2021, name = "number" ) %>%
  mutate( sexual_identity_2010_2014 = paste( sexual_identity_2010, 
                                             sexual_identity_2014, 
                                             sep = "_"
                                             ) )

x123_all$percent <- x123_all$number/sum( x123_all$number )

ordered_levels <- x123_all %>%
  group_by( sexual_identity_2010_2014 ) %>%
  summarize( total = sum( number ) ) %>%
  arrange( desc( total ) ) %>%
  pull( sexual_identity_2010_2014 )

ordered_levels <- as.character( ordered_levels[ ordered_levels != "Heterosexual_Heterosexual" & 
                                                  ordered_levels != "Heterosexual_Other" ] )
ordered_levels <- c( ordered_levels, "Heterosexual_Other", "Heterosexual_Heterosexual" )

x123_all$sexual_identity_2010_2014 <- factor( x123_all$sexual_identity_2010_2014,
                                              levels = ordered_levels )

x123_all$sexual_identity_2021 <- factor( x123_all$sexual_identity_2021,
                                         levels = c( "Homosexual", "Bisexual", "Other", "Heterosexual" )
                                         )

x123_all <- x123_all %>%
  group_by( sexual_identity_2010_2014 ) %>%
  mutate( total = sum( number ) ) %>%
  mutate( percent_for_label = number / total ) %>%
  ungroup()

x123_all$label <- paste0( prettyNum( x123_all$number, big.mark = "," , preserve.width = "none" ), 
                          " (", 
                          sprintf( "%.1f", x123_all$percent_for_label*100 ),
                          "%)" )

x123_all_long <- to_lodes_form( x123_all, axes = c( 5, 3 ), key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010_2014 )
```

##### 3.1.2. By sex
```{r}
m123_sex <- m123 %>%
  count( sexual_identity_2010, sexual_identity_2014, sexual_identity_2021, sex ) %>%
  rename( number = n )

m123_sex <- m123_sex %>%
  group_by( sex ) %>%
  mutate( percent = number / sum( number ) ) %>%
  ungroup()

for ( col in 1:3 ) {
  m123_sex[[col]] <- factor( m123_sex[[col]], levels = c( "Homosexual", "Bisexual", "Other", "Heterosexual" ) ) 
}

# among males
m123_male <- m123_sex %>%
  filter( sex == "Male" ) %>%
  group_by( sexual_identity_2010 ) %>%
  mutate( percent_for_label = number / sum( number ) ) %>%
  ungroup()

m123_male$label <- paste0( prettyNum( m123_male$number, big.mark = "," , preserve.width = "none" ), " (", 
                          sprintf( "%.1f", m123_male$percent_for_label*100 ),
                          "%)" )

m123_male_long <- to_lodes_form( m123_male, axes = 1:3, key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010 )


# among females
m123_female <- m123_sex %>%
  filter( sex == "Female" ) %>%
  group_by( sexual_identity_2010 ) %>%
  mutate( percent_for_label = number / sum( number ) ) %>%
  ungroup()

m123_female$label <- paste0( prettyNum( m123_female$number, big.mark = "," , preserve.width = "none" ), " (", 
                          sprintf( "%.1f", m123_female$percent_for_label*100 ),
                          "%)" )

m123_female_long <- to_lodes_form( m123_female, axes = 1:3, key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010 )
```

##### 3.1.3. By age
```{r}
summary( m123$age_2010 )

m123 <- m123 %>%
  mutate( age_2010_cat = factor( case_when(
    age_2010 <= 29 ~ "18-29",
    age_2010 >= 30 & age_2010 <= 44 ~ "30-44",
    age_2010 >= 45 & age_2010 <= 59 ~ "45-59",
    age_2010 >= 60 ~ ">=60"
    ), 
    levels = c( "18-29", "30-44", "45-59", ">=60" ) ) )

table( m123$age_2010_cat, useNA = "always" )

m123_age <- m123 %>%
  count( sexual_identity_2010, sexual_identity_2014, sexual_identity_2021, age_2010_cat ) %>%
  rename( number = n ) %>%
  group_by( age_2010_cat ) %>%
  mutate( percent = number / sum( number ) ) %>%
  ungroup()

for ( col in 1:3 ) {
  m123_age[[col]] <- factor( m123_age[[col]], levels = c( "Homosexual", "Bisexual", "Other", "Heterosexual" ) ) 
}


# 18-29 yrs
m123_age_18 <- m123_age %>%
  filter( age_2010_cat == "18-29" ) %>%
  group_by( sexual_identity_2010 ) %>%
  mutate( percent_for_label = number / sum( number ) ) %>%
  ungroup()

m123_age_18$label <- paste0( prettyNum( m123_age_18$number, big.mark = "," , preserve.width = "none" ), " (", 
                          sprintf( "%.1f", m123_age_18$percent_for_label*100 ),
                          "%)" )

m123_age_18_long <- to_lodes_form( m123_age_18, axes = 1:3, key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010 )


# 30-44 yrs
m123_age_30 <- m123_age %>%
  filter( age_2010_cat == "30-44" ) %>%
  group_by( sexual_identity_2010 ) %>%
  mutate( percent_for_label = number / sum( number ) ) %>%
  ungroup()

m123_age_30$label <- paste0( prettyNum( m123_age_30$number, big.mark = "," , preserve.width = "none" ), " (", 
                          sprintf( "%.1f", m123_age_30$percent_for_label*100 ),
                          "%)" )

m123_age_30_long <- to_lodes_form( m123_age_30, axes = 1:3, key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010 )


# 45-59 yrs
m123_age_45 <- m123_age %>%
  filter( age_2010_cat == "45-59" ) %>%
  group_by( sexual_identity_2010 ) %>%
  mutate( percent_for_label = number / sum( number ) ) %>%
  ungroup()

m123_age_45$label <- paste0( prettyNum( m123_age_45$number, big.mark = "," , preserve.width = "none" ), " (", 
                          sprintf( "%.1f", m123_age_45$percent_for_label*100 ),
                          "%)" )

m123_age_45_long <- to_lodes_form( m123_age_45, axes = 1:3, key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010 )


# >=60 yrs
m123_age_60 <- m123_age %>%
  filter( age_2010_cat == ">=60" ) %>%
  group_by( sexual_identity_2010 ) %>%
  mutate( percent_for_label = number / sum( number ) ) %>%
  ungroup()

m123_age_60$label <- paste0( prettyNum( m123_age_60$number, big.mark = "," , preserve.width = "none" ), " (", 
                          sprintf( "%.1f", m123_age_60$percent_for_label*100 ),
                          "%)" )

m123_age_60_long <- to_lodes_form( m123_age_60, axes = 1:3, key = "year", value = "sexual_identity", id = "Cohort", diffuse = sexual_identity_2010 )
```

#### 3.2. Plotting
##### 3.2.1. Among all participants
###### 3.2.1.1. Changes of sexual identity from 2010 to 2021
```{r}
ggplot( m123_all_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  geom_alluvium( aes( fill = sexual_identity_2010 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010 ) ) +
  geom_text( stat = "stratum", aes( label = after_stat( stratum ) ), family = "Arial", size = 12 / .pt ) +
  scale_fill_manual( values = c( "#C77CFF", "#00BFC4", "#7CAE00", "#F8766D" ),
                     breaks = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ),
                     na.value = NA ) +
  scale_x_discrete( limits = c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021" ), labels = c( "2010", "2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.9 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
         ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = factor( sexual_identity_2010, 
                                        levels = c( "Other", "Bisexual", "Homosexual", "Heterosexual" ) ),
                        label = ifelse( year == "sexual_identity_2021" & 
                                          ( percent_for_label >= 0.1 | number >= 50 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.25,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
                   )
```

###### 3.2.1.2. Sexual identity in 2021 based on 2010 and 2014
```{r}
all_colors <- c( "#00BFC4", "#7CAE00", "#FFA500", "#F8766D", 
                 "yellow2", "#0092FF", "#00FF00", "#4B0082", 
                 "#0000FF", "#DEB887", "#00A86B", "#FF0000", 
                 "#FF00DB", "#E6E6FA", "#87CEEB", "#C77CFF" )

legend_labels <- setNames(
  c( "Homo to Homo", "Bisexual to bisexual", "Hetero to bisexual", "Uncertain to other",
     "Homo to Hetero", "Bisexual to Hetero", "Uncertain to Hetero", "Bisexual to other",
     "Hetero to Homo", "Uncertain to bisexual", "Bisexual to Homo", "Homo to bisexual",
     "Homo to other", "Uncertain to Homo", "Hetero to other", "Hetero to Hetero"),
  ordered_levels )

ggplot( x123_all_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  
  geom_alluvium( aes( fill = sexual_identity_2010_2014 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010_2014 ) ) +
  
  geom_text( data = subset( x123_all_long, year == "sexual_identity_2021"), 
             stat = "stratum", 
             aes( label = after_stat( stratum ) ), 
             family = "Arial", 
             size = 12 / .pt ) +
  
  scale_fill_manual( values = all_colors,
                     breaks = ordered_levels,
                     labels = legend_labels,
                     na.value = NA ) +
  
  scale_x_discrete( limits = c( "sexual_identity_2010_2014", "sexual_identity_2021" ), labels = c( "2010–2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.9 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
  ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = sexual_identity_2010_2014,
                        label = ifelse( year == "sexual_identity_2021" & 
                                          ( percent_for_label >= 0.05 & number >= 25 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.25,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
  ) +
  scale_color_manual( values = all_colors,
                      breaks = ordered_levels )
```

##### 3.2.2. By sex
```{r}
# among males
ggplot( m123_male_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  geom_alluvium( aes( fill = sexual_identity_2010 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010 ) ) +
  geom_text( stat = "stratum", aes( label = after_stat( stratum ) ), family = "Arial", size = 12 / .pt ) +
  scale_fill_manual( values = c( "#C77CFF", "#00BFC4", "#7CAE00", "#F8766D" ),
                     breaks = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ),
                     na.value = NA ) +
  scale_x_discrete( limits = c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021" ), labels = c( "2010", "2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.9 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
         ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = factor( sexual_identity_2010, levels = c( "Other", "Bisexual", "Homosexual", "Heterosexual" ) ),
                        label = ifelse( year == "sexual_identity_2021" & ( percent_for_label >= 0.1 | number >= 15 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.25,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
                   )


# among females
ggplot( m123_female_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  geom_alluvium( aes( fill = sexual_identity_2010 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010 ) ) +
  geom_text( stat = "stratum", aes( label = after_stat( stratum ) ), family = "Arial", size = 12 / .pt ) +
  scale_fill_manual( values = c( "#C77CFF", "#00BFC4", "#7CAE00", "#F8766D" ),
                     breaks = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ),
                     na.value = NA ) +
  scale_x_discrete( limits = c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021" ), labels = c( "2010", "2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.9 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
         ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = factor( sexual_identity_2010, levels = c( "Other", "Bisexual", "Homosexual", "Heterosexual" ) ),
                        label = ifelse( year == "sexual_identity_2021" & ( percent_for_label >= 0.1 | number >= 30 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.25,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
                   )
```

##### 3.2.3. By age
```{r}
# 18-29 years 
ggplot( m123_age_18_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  geom_alluvium( aes( fill = sexual_identity_2010 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010 ) ) +
  geom_text( stat = "stratum", aes( label = after_stat( stratum ) ), family = "Arial", size = 12 / .pt ) +
  scale_fill_manual( values = c( "#C77CFF", "#00BFC4", "#7CAE00", "#F8766D" ),
                     breaks = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ),
                     na.value = NA ) +
  scale_x_discrete( limits = c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021" ), labels = c( "2010", "2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.86 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
         ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = factor( sexual_identity_2010, levels = c( "Other", "Bisexual", "Homosexual", "Heterosexual" ) ),
                        label = ifelse( year == "sexual_identity_2021" & ( percent_for_label >= 0.1 | number >= 6 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.25,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
                   )


# 30-44 years
ggplot( m123_age_30_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  geom_alluvium( aes( fill = sexual_identity_2010 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010 ) ) +
  geom_text( stat = "stratum", aes( label = after_stat( stratum ) ), family = "Arial", size = 12 / .pt ) +
  scale_fill_manual( values = c( "#C77CFF", "#00BFC4", "#7CAE00", "#F8766D" ),
                     breaks = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ),
                     na.value = NA ) +
  scale_x_discrete( limits = c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021" ), labels = c( "2010", "2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.91 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
         ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = factor( sexual_identity_2010, levels = c( "Other", "Bisexual", "Homosexual", "Heterosexual" ) ),
                        label = ifelse( year == "sexual_identity_2021" & ( percent_for_label >= 0.1 | number >= 12 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.25,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
                   )


# 45-59 years
ggplot( m123_age_45_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  geom_alluvium( aes( fill = sexual_identity_2010 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010 ) ) +
  geom_text( stat = "stratum", aes( label = after_stat( stratum ) ), family = "Arial", size = 12 / .pt ) +
  scale_fill_manual( values = c( "#C77CFF", "#00BFC4", "#7CAE00", "#F8766D" ),
                     breaks = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ),
                     na.value = NA ) +
  scale_x_discrete( limits = c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021" ), labels = c( "2010", "2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.91 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
         ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = factor( sexual_identity_2010, levels = c( "Other", "Bisexual", "Homosexual", "Heterosexual" ) ),
                        label = ifelse( year == "sexual_identity_2021" & ( percent_for_label >= 0.1 | number >= 15 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.25,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
                   )


# >=60
ggplot( m123_age_60_long,
        aes( x = year,
             stratum = sexual_identity, 
             alluvium = Cohort,
             y = percent ) ) +
  geom_alluvium( aes( fill = sexual_identity_2010 ), curve_type = "cubic" ) +
  geom_stratum( aes( fill = sexual_identity_2010 ) ) +
  geom_text( stat = "stratum", aes( label = after_stat( stratum ) ), family = "Arial", size = 12 / .pt ) +
  scale_fill_manual( values = c( "#C77CFF", "#00BFC4", "#7CAE00", "#F8766D" ),
                     breaks = c( "Heterosexual", "Homosexual", "Bisexual", "Other" ),
                     na.value = NA ) +
  scale_x_discrete( limits = c( "sexual_identity_2010", "sexual_identity_2014", "sexual_identity_2021" ), labels = c( "2010", "2014", "2021" ), expand = c( 0, 0 ) ) +
  theme_classic() +
  scale_y_break( c( 0.12, 0.88 ), scales = 10, space = 0.3 ) +
  scale_y_continuous( labels = scales::percent, breaks = c( 0, 0.1, 0.9, 0.95, 1 ) ) +
  labs( x = NULL, y = NULL) +
  theme( axis.text.x = element_text( family = "Arial", size = 11 ),
         axis.text.y = element_text( family = "Arial", size = 11 ),
         legend.title = element_blank(),
         legend.text = element_text( family = "Arial", size = 10 ), 
         legend.key = element_rect( colour = "white" ),
         legend.position = "bottom",
         axis.ticks.x.bottom = element_blank(),
         axis.line.x.bottom = element_blank(),
         axis.text.y.right = element_blank(),
         axis.ticks.y.right = element_blank(),
         axis.line.y.right = element_blank()
         ) +
  geom_text_repel( stat = "alluvium",
                   aes( x = as.integer( year ) + 0.15,
                        color = factor( sexual_identity_2010, levels = c( "Other", "Bisexual", "Homosexual", "Heterosexual" ) ),
                        label = ifelse( year == "sexual_identity_2021" & ( percent_for_label >= 0.1 | number >= 20 ), label, NA ) ),
                   size = 4.5,
                   family = "Arial",
                   segment.linetype = 3,
                   segment.size = 0.55,
                   direction = "y",
                   nudge_x = 0.25,
                   box.padding = 0.5,
                   point.padding = 0,
                   show.legend = FALSE,
                   seed = 123
                   )
```

### 4. Relation between Changes of Sexual Identity and Demographic Factors
#### 4.1. Prepare dataset
```{r}
# exposures of interest, including age, sex, country of birth, education, income, marital status, living status, and personal support
d_2010$age_exp <- relevel( d_2010$age_cat, ref = "45-59" )

d_2010$sex_exp <- relevel( d_2010$sex, ref = "Male" )

d_2010$country_of_birth_exp <- factor( 
  ifelse( d_2010$country_of_birth == "Sweden", "Sweden",
          ifelse( d_2010$country_of_birth == "Europe", "Europe", "Outside Europe" ) ),
  levels = c( "Sweden", "Europe", "Outside Europe" )
  )

d_2010$education_exp <- relevel( d_2010$education, ref = ">=13 years" )

d_2010$income_exp <- relevel( d_2010$income, ref = ">4,500" )

d_2010$marital_status_exp <- relevel( d_2010$marital_status, ref = "Currently married" )

d_2010$living_status_exp <- relevel( d_2010$living_alone, ref = "no" )

d_2010$personal_support_exp <- relevel( d_2010$personal_support, ref = "yes" )


# outcomes of interest, including sexual minority, homosexual, bisexual, and other
d_2010$change_of_sexual_identity <- ifelse( d_2010$sexual_identity_2010 != d_2010$sexual_identity_2021, 1, 0 )


# confounding variables, including age, sex, country of birth, education, income, marital status, 
# and place of residence (i.e., sampling strata)
d_2010$age_conf <- d_2010$age # age

d_2010$sex_conf <- d_2010$sex # sex

d_2010$country_of_birth_conf <- d_2010$country_of_birth # country of birth (grouped into five categories due to sparse data)

d_2010$education_conf <- as.factor( d_2010$utbniva2010 ) # education

d_2010$income_conf <- d_2010$dispink2010 # disposable income

d_2010$marital_status_conf <- d_2010$marital_status # marital status (grouped into three categories due to sparse data)

d_2010$place_of_residence_conf <- d_2010$place_of_residence # place of residence
```
